!function(globalFunctionEval){var Yabble=function(){throw"Synchronous require() is not supported."};Yabble.unit={};var _moduleRoot="",_modules,_callbacks,_fetchFunc,_timeoutLength=2e4,_mainProgram,isWebWorker=void 0!==this.importScripts,head=!isWebWorker&&document.getElementsByTagName("head")[0],hasOwnProperty=Object.prototype.hasOwnProperty;if("hasOwnProperty"==function(){for(var prop in{hasOwnProperty:!0})return prop}())var forIn=function(obj,func,ctx){for(var prop in obj)hasOwnProperty.call(obj,prop)&&func.call(ctx,prop)};else var ieBadProps=["isPrototypeOf","hasOwnProperty","toLocaleString","toString","valueOf"],forIn=function(obj,func,ctx){for(var prop in obj)hasOwnProperty.call(obj,prop)&&func.call(ctx,prop);for(var i=ieBadProps.length;i--;){var prop=ieBadProps[i];hasOwnProperty.call(obj,prop)&&func.call(ctx,prop)}};var indexOf=function(arr,val){for(var i=arr.length;i--;)if(arr[i]==val)return i;return-1},removeWhere=function(arr,func){for(var i=0;i<arr.length;)func.call(null,arr[i],i)===!0?arr.splice(i,1):i++},combinePaths=function(relPath,refPath){var relPathParts=relPath.split("/");refPath=refPath||"",refPath.length&&"/"!=refPath.charAt(refPath.length-1)&&(refPath+="/");var refPathParts=refPath.split("/");refPathParts.pop();for(var part;part=relPathParts.shift();)"."!=part&&(".."==part&&refPathParts.length&&".."!=refPathParts[refPathParts.length-1]?refPathParts.pop():refPathParts.push(part));return refPathParts.join("/")},resolveModuleId=Yabble.unit.resolveModuleId=function(relModuleId,refPath){return"."!=relModuleId.charAt(0)?relModuleId:combinePaths(relModuleId,refPath)},resolveModuleUri=function(moduleId){return"."!=moduleId.charAt(0)?_moduleRoot+moduleId+".js":this._resolveModuleId(moduleId,_moduleRoot)+".js"},getModule=function(moduleId){return hasOwnProperty.call(_modules,moduleId)?_modules[moduleId]:null},addCallback=function(deps,cb){_callbacks.push([deps.slice(0),cb])},ensureImpl=function(deps,cb,refPath){for(var unreadyModules=[],i=deps.length;i--;){{var moduleId=resolveModuleId(deps[i],refPath);getModule(moduleId)}areDeepDepsDefined(moduleId)||unreadyModules.push(moduleId)}unreadyModules.length?(addCallback(unreadyModules,function(){cb(createRequireFunc(refPath))}),queueModules(unreadyModules)):setTimeout(function(){cb(createRequireFunc(refPath))},0)},createRequireFunc=function(refPath){var require=function(relModuleId){var moduleId=resolveModuleId(relModuleId,refPath),module=getModule(moduleId);if(!module)throw"Module not loaded";if(module.error)throw"Error loading module";if(!module.exports){module.exports={};for(var moduleDir=moduleId.substring(0,moduleId.lastIndexOf("/")+1),injects=module.injects,args=[],i=0,n=injects.length;n>i;i++)"require"==injects[i]?args.push(createRequireFunc(moduleDir)):"exports"==injects[i]?args.push(module.exports):"module"==injects[i]&&args.push(module.module);module.factory.apply(null,args)}return module.exports};return require.ensure=function(deps,cb){ensureImpl(deps,cb,refPath)},null!=_mainProgram&&(require.main=getModule(_mainProgram).module),require},queueModules=function(moduleIds){for(var i=moduleIds.length;i--;){var moduleId=moduleIds[i],module=getModule(moduleId);null==module&&(module=_modules[moduleId]={},_fetchFunc(moduleId))}},areDeepDepsDefined=function(moduleId){var visitedModules={},recurse=function(moduleId){if(1==visitedModules[moduleId])return!0;visitedModules[moduleId]=!0;var module=getModule(moduleId);if(module&&module.defined){for(var deps=module.deps||[],i=deps.length;i--;)if(!recurse(deps[i]))return!1;return!0}return!1};return recurse(moduleId)},fireCallbacks=function(){for(var i=0;i<_callbacks.length;){for(var deps=_callbacks[i][0],func=_callbacks[i][1],n=0;n<deps.length;)areDeepDepsDefined(deps[n])?deps.splice(n,1):n++;deps.length?i++:(_callbacks.splice(i,1),null!=func&&setTimeout(func,0))}},loadModuleByEval=_fetchFunc=function(moduleId){var timeoutHandle,errorFunc=function(){var module=getModule(moduleId);module.defined||(module.defined=module.error=!0,fireCallbacks())},xhr=this.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),moduleUri=resolveModuleUri(moduleId);xhr.open("GET",moduleUri,!0),xhr.onreadystatechange=function(){if(4===xhr.readyState)if(clearTimeout(timeoutHandle),200==xhr.status||0===xhr.status){for(var moduleCode=xhr.responseText,deps=determineShallowDependencies(moduleCode),moduleDir=moduleId.substring(0,moduleId.lastIndexOf("/")+1),moduleDefs={},i=deps.length;i--;)deps[i]=resolveModuleId(deps[i],moduleDir);try{moduleDefs[moduleId]=globalFunctionEval("\r\n"+moduleCode+"\r\n")}catch(e){if(e instanceof SyntaxError){var msg="Syntax Error: ";e.lineNumber?msg+="line "+(e.lineNumber-581):console.log("GameJs tip: use Firefox to see line numbers in Syntax Errors."),msg+=" in file "+moduleUri,console.log(msg)}throw e}Yabble.define(moduleDefs,deps)}else errorFunc()},timeoutHandle=setTimeout(errorFunc,_timeoutLength),xhr.send(null)},determineShallowDependencies=Yabble.unit.determineShallowDependencies=function(moduleCode){for(var deps={},match,unique={},requireRegex=/(?:^|[^\w\$_.])require\s*\(\s*("[^"\\]*(?:\\.[^"\\]*)*"|'[^'\\]*(?:\\.[^'\\]*)*')\s*\)/g;match=requireRegex.exec(moduleCode);){var module=eval(match[1]);hasOwnProperty.call(deps,module)||(deps[module]=!0)}for(var ensureRegex=/(?:^|[^\w\$_.])require.ensure\s*\(\s*(\[("[^"\\]*(?:\\.[^"\\]*)*"|'[^'\\]*(?:\\.[^'\\]*)*'|\s*|,)*\])/g;match=ensureRegex.exec(moduleCode);)for(var moduleArray=eval(match[1]),i=moduleArray.length;i--;){var module=moduleArray[i];delete deps[module]}var depsArray=[];return forIn(deps,function(module){depsArray.push(module)}),depsArray},loadModuleByScript=function(moduleId){var scriptEl=document.createElement("script");scriptEl.type="text/javascript",scriptEl.src=resolveModuleUri(moduleId);var timeoutHandle,useStandard=!!scriptEl.addEventListener,errorFunc=function(){postLoadFunc(!1)},loadFunc=function(){(useStandard||"complete"==scriptEl.readyState||"loaded"==scriptEl.readyState)&&postLoadFunc(getModule(moduleId).defined)},postLoadFunc=function(loaded){if(clearTimeout(timeoutHandle),useStandard?(scriptEl.removeEventListener("load",loadFunc,!1),scriptEl.removeEventListener("error",errorFunc,!1)):scriptEl.detachEvent("onreadystatechange",loadFunc),!loaded){var module=getModule(moduleId);module.defined||(module.defined=module.error=!0,fireCallbacks())}};useStandard?(scriptEl.addEventListener("load",loadFunc,!1),scriptEl.addEventListener("error",errorFunc,!1)):scriptEl.attachEvent("onreadystatechange",loadFunc),timeoutHandle=setTimeout(errorFunc,_timeoutLength),head.appendChild(scriptEl)},normalizeTransport=function(){var transport={modules:[]},standardInjects=["require","exports","module"];if("object"==typeof arguments[0]){transport.deps=arguments[1]||[];var moduleDefs=arguments[0];forIn(moduleDefs,function(moduleId){var module={id:moduleId};"function"==typeof moduleDefs[moduleId]?(module.factory=moduleDefs[moduleId],module.injects=standardInjects):(module.factory=moduleDefs[moduleId].factory,module.injects=moduleDefs[moduleId].injects||standardInjects),transport.modules.push(module)})}else transport.deps=arguments[1].slice(0),removeWhere(transport.deps,function(dep){return indexOf(standardInjects,dep)>=0}),transport.modules.push({id:arguments[0],factory:arguments[2],injects:arguments[1]});return transport};Yabble.setModuleRoot=function(path){if(this.window&&!/^http(s?):\/\//.test(path)){var href=window.location.href;href=href.substr(0,href.lastIndexOf("/")+1),path=combinePaths(path,href)}path.length&&"/"!=path.charAt(path.length-1)&&(path+="/"),_moduleRoot=path},Yabble.getModuleRoot=function(){return _moduleRoot},Yabble.setTimeoutLength=function(milliseconds){_timeoutLength=milliseconds},Yabble.useScriptTags=function(){_fetchFunc=loadModuleByScript},Yabble.def=Yabble.define=function(){for(var transport=normalizeTransport.apply(null,arguments),unreadyModules=[],definedModules=[],deps=transport.deps,i=transport.modules.length;i--;){var moduleDef=transport.modules[i],moduleId=moduleDef.id,module=getModule(moduleId);module||(module=_modules[moduleId]={}),module.module={id:moduleId,uri:resolveModuleUri(moduleId)},module.defined=!0,module.deps=deps.slice(0),module.injects=moduleDef.injects,module.factory=moduleDef.factory,definedModules.push(module)}for(var i=deps.length;i--;){var moduleId=deps[i],module=getModule(moduleId);module&&areDeepDepsDefined(moduleId)||unreadyModules.push(moduleId)}unreadyModules.length&&setTimeout(function(){queueModules(unreadyModules)},0),fireCallbacks()},Yabble.isKnown=function(moduleId){return null!=getModule(moduleId)},Yabble.isDefined=function(moduleId){var module=getModule(moduleId);return!(!module||!module.defined)},Yabble.ensure=function(deps,cb){ensureImpl(deps,cb,"")},Yabble.run=function(program,cb){program=_mainProgram=resolveModuleId(program,""),Yabble.ensure([program],function(require){require(program),null!=cb&&cb()})},Yabble.reset=function(){_mainProgram=null,_modules={},_callbacks=[],Yabble.define({system:function(){}})},Yabble.reset(),isWebWorker?self.require=Yabble:window.require=Yabble}(function(code){with(this.importScripts?self:window)return new Function("require","exports","module",code)}),require.define({gamejs:function(require,exports){var objects=(require("./gamejs/math/matrix"),require("./gamejs/utils/objects")),Callback=require("./gamejs/utils/callback").Callback,gamejs=exports,RESOURCES={};exports.thread=require("./gamejs/thread"),exports.ready=gamejs.thread.inWorker===!0?function(readyFn){require("./gamejs/thread")._ready(),gamejs.init(),readyFn()}:function(readyFn){function _ready(){if(!document.body)return window.setTimeout(_ready,50);getImageProgress=gamejs.image.preload(RESOURCES);try{getMixerProgress=gamejs.audio.preload(RESOURCES)}catch(e){gamejs.debug("Error loading audio files ",e)}window.setTimeout(_readyResources,50)}function _readyResources(){return getImageProgress()<1||getMixerProgress()<1?window.setTimeout(_readyResources,100):(gamejs.display.init(),gamejs.image.init(),gamejs.audio.init(),gamejs.event.init(),gamejs.math.random.init(),void readyFn())}function getLoadProgress(){return getImageProgress?.5*getImageProgress()+.5*getMixerProgress():.1}var getMixerProgress=null,getImageProgress=null;return gamejs.time.init(),window.setTimeout(_ready,13),getLoadProgress},exports.init=function(){var errorModules={};return["time","display","image","audio","event"].forEach(function(moduleName){try{gamejs[moduleName].init()}catch(e){errorModules[moduleName]=e.toString()}}),errorModules};{var resourceBaseHref=function(){return window.$g&&window.$g.resourceBaseHref||document.location.href};exports.preload=function(resources){var uri=require("./gamejs/utils/uri"),baseHref=resourceBaseHref();resources.forEach(function(res){RESOURCES[res]=uri.resolve(baseHref,res)},this)}}exports.onTick=function(fn,scope){exports.time._CALLBACKS.push(new Callback(fn,scope))};var normalizeRectArguments=exports.normalizeRectArguments=function(){var left=0,top=0,width=0,height=0;if(2===arguments.length)arguments[0]instanceof Array&&arguments[1]instanceof Array?(left=arguments[0][0],top=arguments[0][1],width=arguments[1][0],height=arguments[1][1]):(left=arguments[0],top=arguments[1]);else if(1===arguments.length&&arguments[0]instanceof Array)left=arguments[0][0],top=arguments[0][1],width=arguments[0][2],height=arguments[0][3];else if(1===arguments.length&&arguments[0]instanceof Rect)left=arguments[0].left,top=arguments[0].top,width=arguments[0].width,height=arguments[0].height;else{if(4!==arguments.length)throw new Error("not a valid rectangle specification");left=arguments[0],top=arguments[1],width=arguments[2],height=arguments[3]}return{left:left||0,top:top||0,width:width||0,height:height||0}},Rect=exports.Rect=function(){var args=normalizeRectArguments.apply(this,arguments);return this.left=args.left,this.top=args.top,this.width=args.width,this.height=args.height,this};objects.accessors(Rect.prototype,{bottom:{get:function(){return this.top+this.height},set:function(newValue){this.top=newValue-this.height}},right:{get:function(){return this.left+this.width},set:function(newValue){this.left=newValue-this.width}},center:{get:function(){return[this.left+this.width/2|0,this.top+this.height/2|0]},set:function(){var args=normalizeRectArguments.apply(this,arguments);this.left=args.left-this.width/2|0,this.top=args.top-this.height/2|0}},topleft:{get:function(){return[this.left,this.top]},set:function(){var args=normalizeRectArguments.apply(this,arguments);this.left=args.left,this.top=args.top}},bottomleft:{get:function(){return[this.left,this.bottom]},set:function(){var args=normalizeRectArguments.apply(this,arguments);this.left=args.left,this.bottom=args.top}},topright:{get:function(){return[this.right,this.top]},set:function(){var args=normalizeRectArguments.apply(this,arguments);this.right=args.left,this.top=args.top}},bottomright:{get:function(){return[this.right,this.bottom]},set:function(){var args=normalizeRectArguments.apply(this,arguments);this.right=args.left,this.bottom=args.top}},x:{get:function(){return this.left},set:function(newValue){this.left=newValue}},y:{get:function(){return this.top},set:function(newValue){this.top=newValue}}}),Rect.prototype.move=function(){var args=normalizeRectArguments.apply(this,arguments);return new Rect(this.left+args.left,this.top+args.top,this.width,this.height)},Rect.prototype.moveIp=function(){var args=normalizeRectArguments.apply(this,arguments);this.left+=args.left,this.top+=args.top},Rect.prototype.clip=function(rect){if(!this.collideRect(rect))return new Rect(0,0,0,0);var x,y,width,height;return this.left>=rect.left&&this.left<rect.right?x=this.left:rect.left>=this.left&&rect.left<this.right&&(x=rect.left),this.right>rect.left&&this.right<=rect.right?width=this.right-x:rect.right>this.left&&rect.right<=this.right&&(width=rect.right-x),this.top>=rect.top&&this.top<rect.bottom?y=this.top:rect.top>=this.top&&rect.top<this.bottom&&(y=rect.top),this.bottom>rect.top&&this.bottom<=rect.bottom?height=this.bottom-y:rect.bottom>this.top&&rect.bottom<=this.bottom&&(height=rect.bottom-y),new Rect(x,y,width,height)},Rect.prototype.union=function(rect){var x,y,width,height;return x=Math.min(this.left,rect.left),y=Math.min(this.top,rect.top),width=Math.max(this.right,rect.right)-x,height=Math.max(this.bottom,rect.bottom)-y,new Rect(x,y,width,height)},Rect.prototype.inflate=function(x,y){var copy=this.clone();return copy.inflateIp(x,y),copy},Rect.prototype.inflateIp=function(x,y){this.left-=Math.floor(x/2),this.top-=Math.floor(y/2),this.width+=x,this.height+=y},Rect.prototype.collidePoint=function(){var args=normalizeRectArguments.apply(this,arguments);return this.left<=args.left&&args.left<=this.right&&this.top<=args.top&&args.top<=this.bottom},Rect.prototype.collideRect=function(rect){return!(this.left>rect.right||this.right<rect.left||this.top>rect.bottom||this.bottom<rect.top)},Rect.prototype.collideLine=function(p1,p2){function linePosition(point){var x=point[0],y=point[1];return(y2-y1)*x+(x1-x2)*y+(x2*y1-x1*y2)}var x1=p1[0],y1=p1[1],x2=p2[0],y2=p2[1],relPoses=[[this.left,this.top],[this.left,this.bottom],[this.right,this.top],[this.right,this.bottom]].map(linePosition),noNegative=!0,noPositive=!0,noZero=!0;return relPoses.forEach(function(relPos){relPos>0?noPositive=!1:0>relPos?noNegative=!1:0===relPos&&(noZero=!1)},this),(noNegative||noPositive)&&noZero?!1:!(x1>this.right&&x2>this.right||x1<this.left&&x2<this.left||y1<this.top&&y2<this.top||y1>this.bottom&&y2>this.bottom)},Rect.prototype.toString=function(){return["[",this.left,",",this.top,"]"," [",this.width,",",this.height,"]"].join("")},Rect.prototype.clone=function(){return new Rect(this)},exports.event=require("./gamejs/event"),exports.font=require("./gamejs/font"),exports.http=require("./gamejs/http"),exports.image=require("./gamejs/image"),exports.audio=require("./gamejs/audio"),exports.graphics=require("./gamejs/graphics"),exports.logging=require("./gamejs/logging"),exports.math={matrix:require("./gamejs/math/matrix"),vectors:require("./gamejs/math/vectors"),angles:require("./gamejs/math/angles"),binaryheap:require("./gamejs/math/binaryheap"),random:require("./gamejs/math/random"),noise:require("./gamejs/math/noise")},exports.utils={arrays:require("./gamejs/utils/arrays"),objects:require("./gamejs/utils/objects"),uri:require("./gamejs/utils/uri"),strings:require("./gamejs/utils/strings"),xml:require("./gamejs/utils/xml"),base64:require("./gamejs/utils/base64")},exports.display=require("./gamejs/display"),exports.pathfinding=require("./gamejs/pathfinding"),exports.tiledmap=require("./gamejs/tiledmap"),exports.time=require("./gamejs/time")}},["gamejs/math/matrix","gamejs/utils/objects","gamejs/utils/callback","gamejs","gamejs/thread","gamejs/utils/uri","gamejs/event","gamejs/font","gamejs/http","gamejs/image","gamejs/audio","gamejs/graphics","gamejs/logging","gamejs/math/vectors","gamejs/math/angles","gamejs/math/binaryheap","gamejs/math/random","gamejs/math/noise","gamejs/utils/arrays","gamejs/utils/strings","gamejs/utils/xml","gamejs/utils/base64","gamejs/display","gamejs/pathfinding","gamejs/tiledmap","gamejs/time"]),require.define({"gamejs/animate":function(require,exports){var gamejs=require("../gamejs"),SpriteSheet=exports.SpriteSheet=function(image,opts){this.width=opts.width,this.height=opts.height,this.spacing=opts.spacing||0,this.margin=opts.margin||0,this.image=image,this.surfaceCache=[];var imgSize=new gamejs.Rect([0,0],[this.width,this.height]);opts.scaleTo&&(imgSize=new gamejs.Rect([0,0],opts.scaleTo));for(var i=this.margin;i<this.image.rect.height;i+=this.height+this.spacing)for(var j=this.margin;j<this.image.rect.width;j+=this.width+this.spacing){var surface=new gamejs.graphics.Surface([this.width,this.height]),rect=new gamejs.Rect(j,i,this.width,this.height);surface.blit(this.image,imgSize,rect),this.surfaceCache.push(surface)}return this};SpriteSheet.prototype.get=function(index){return this.surfaceCache[index]};var Animation=exports.Animation=function(spriteSheet,initial,spec){this.spec=spec,this.currentFrame=null,this.currentFrameDuration=0,this.currentAnimation=null,this._isFinished=!1,this.spriteSheet=spriteSheet,this.image=spriteSheet.get(0),this.start(initial)};Animation.prototype.setFrame=function(frame){this.frameIndex=frame},Animation.prototype.start=function(name){this._isFinished=!1,this.setState(name),this.update(0)},Animation.prototype.setState=function(name){this.currentAnimation!==name&&(this.currentAnimation=name,this.currentFrame=this.spec[name].frames[0],this.frameIndex=0,this.currentFrameDuration=0,this.frameDuration=1e3/this.spec[name].rate)},Animation.prototype.update=function(msDuration){if(!this.currentAnimation)throw new Error("No animation started.");if(this.currentFrameDuration+=msDuration,this.currentFrameDuration>=this.frameDuration&&this._isFinished===!1){var frames=this.spec[this.currentAnimation].frames;this.currentFrame=frames[this.frameIndex++],this.currentFrameDuration=0;var length=this.spec[this.currentAnimation].frames.length-1;return this.frameIndex>length&&(this.spec[this.currentAnimation].loop?(this.frameIndex=0,this.currentFrame=frames[this.frameIndex]):(this._isFinished=!0,this.frameIndex--,this.currentFrame=frames[this.frameIndex])),this.image=this.spriteSheet.get(this.currentFrame),!0}return!1},Animation.prototype.isFinished=function(){return this._isFinished}}},["gamejs"]),require.define({"gamejs/audio":function(require,exports){function addToCache(audios){audios instanceof Array||(audios=[audios]);document.location.href;audios.forEach(function(audio){CACHE[audio.gamejsKey]=audio})}var CACHE=(require("../gamejs"),{}),_PRELOADING=!1,NUM_CHANNELS=8;exports.setNumChannels=function(count){NUM_CHANNELS=parseInt(count,10)||NUM_CHANNELS},exports.getNumChannels=function(){return NUM_CHANNELS},exports.init=function(){var audios=Array.prototype.slice.call(document.getElementsByTagName("audio"),0);addToCache(audios)},exports.preload=function(audioUrls){function incrementLoaded(){countLoaded++,countLoaded==countTotal&&(_PRELOADING=!1)}function getProgress(){return countTotal>0?countLoaded/countTotal:1}function successHandler(){addToCache(this),incrementLoaded()}function errorHandler(){throw incrementLoaded(),new Error("Error loading "+this.src)}var countTotal=0,countLoaded=0;for(var key in audioUrls)if(-1!=key.indexOf("wav")||-1!=key.indexOf("ogg")||-1!=key.indexOf("webm")){countTotal++;var audio=new Audio;audio.addEventListener("canplay",successHandler,!0),audio.addEventListener("error",errorHandler,!0),audio.src=audioUrls[key],audio.gamejsKey=key,audio.load()}return countTotal>0&&(_PRELOADING=!0),getProgress},exports.isPreloading=function(){return _PRELOADING},exports.Sound=function(uriOrAudio){var cachedAudio;if(cachedAudio="string"==typeof uriOrAudio?CACHE[uriOrAudio]:uriOrAudio,!cachedAudio)throw new Error('Missing "'+uriOrAudio+'", gamejs.preload() all audio files before loading');for(var channels=[],i=NUM_CHANNELS;i-->0;){var audio=new Audio;audio.preload="auto",audio.loop=!1,audio.src=cachedAudio.src,channels.push(audio)}return this.play=function(loop){channels.some(function(audio){return audio.ended||audio.paused?(audio.loop=!!loop,audio.play(),!0):!1})},this.stop=function(){channels.forEach(function(audio){audio.stop()})},this.setVolume=function(value){channels.forEach(function(audio){audio.volume=value})},this.getVolume=function(){return channels[0].volume},this.getLength=function(){return channels[0].duration},this}}},["gamejs"]),require.define({"gamejs/display":function(require,exports){function onResize(){var canvas=getCanvas();SURFACE._canvas.width=canvas.clientWidth,SURFACE._canvas.height=canvas.clientHeight,require("./event")._triggerCallbacks({type:require("./event").DISPLAY_RESIZE})}var Surface=require("./graphics").Surface,CANVAS_ID="gjs-canvas",LOADER_ID="gjs-loader",SURFACE=null,DISABLE_SMOOTHING=exports.DISABLE_SMOOTHING=2,FULLSCREEN=exports.FULLSCREEN=4,POINTERLOCK=exports.POINTERLOCK=8,_flags=0,getCanvas=exports._getCanvas=function(){var displayCanvas=document.getElementById(CANVAS_ID);return displayCanvas||(displayCanvas=document.createElement("canvas"),displayCanvas.setAttribute("id",CANVAS_ID),document.body.appendChild(displayCanvas)),displayCanvas},getFullScreenToggle=function(){var fullScreenButton=document.getElementById("gjs-fullscreen-toggle");if(!fullScreenButton){fullScreenButton=document.createElement("button"),fullScreenButton.innerHTML="Fullscreen",fullScreenButton.id="gjs-fullscreen-toggle";var canvas=getCanvas();canvas.parentNode.insertBefore(fullScreenButton,canvas),canvas.parentNode.insertBefore(document.createElement("br"),canvas)}return fullScreenButton},fullScreenChange=function(){var gjsEvent={type:isFullScreen()?require("./event").DISPLAY_FULLSCREEN_ENABLED:require("./event").DISPLAY_FULLSCREEN_DISABLED};isFullScreen()&&_flags&POINTERLOCK&&enablePointerLock(),require("./event")._triggerCallbacks(gjsEvent)};exports.hasPointerLock=function(){return!!(document.pointerLockElement||document.webkitFullscreenElement||document.mozFullscreenElement||document.mozFullScreenElement)},exports.init=function(){var canvas=getCanvas();canvas.getAttribute("tabindex")||(canvas.setAttribute("tabindex",1),canvas.focus());var $loader=document.getElementById(LOADER_ID);$loader&&($loader.style.display="none");var $displaySurface=document.getElementById(CANVAS_ID);$displaySurface&&($displaySurface.style.display="block"),window.addEventListener("resize",onResize,!1)};var isFullScreen=exports.isFullscreen=function(){return document.fullScreenElement||document.mozFullScreen||document.webkitIsFullScreen||document.webkitDisplayingFullscreen},enableFullScreen=function(){var wrapper=getCanvas();return wrapper.requestFullScreen=wrapper.requestFullScreen||wrapper.mozRequestFullScreen||wrapper.webkitRequestFullScreen,wrapper.requestFullScreen?(Element.ALLOW_KEYBOARD_INPUT?wrapper.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT):wrapper.requestFullScreen(),!0):!1},enablePointerLock=function(){var wrapper=getCanvas();wrapper.requestPointerLock=wrapper.requestPointerLock||wrapper.mozRequestPointerLock||wrapper.webkitRequestPointerLock,wrapper.requestPointerLock&&wrapper.requestPointerLock()};exports._hasFocus=function(){return document.activeElement==getCanvas()},exports.setMode=function(dimensions,flags){SURFACE=null;var canvas=getCanvas();if(canvas.width=canvas.clientWidth=dimensions[0],canvas.height=canvas.clientHeight=dimensions[1],_flags=_flags||flags,_flags&POINTERLOCK&&(_flags|=FULLSCREEN),_flags&FULLSCREEN){var fullScreenToggle=getFullScreenToggle();fullScreenToggle.removeEventListener("click",enableFullScreen,!1),fullScreenToggle.addEventListener("click",enableFullScreen,!1),document.removeEventListener("fullScreenchange",fullScreenChange,!1),document.removeEventListener("webkitfullscreenchange",fullScreenChange,!1),document.removeEventListener("mozfullscreenchange",fullScreenChange,!1),document.addEventListener("fullscreenchange",fullScreenChange,!1),document.addEventListener("webkitfullscreenchange",fullScreenChange,!1),document.addEventListener("mozfullscreenchange",fullScreenChange,!1)}return getSurface(dimensions)},exports.setCaption=function(title){document.title=title},exports._isSmoothingEnabled=function(){return!(_flags&DISABLE_SMOOTHING)},exports._getCanvasOffset=function(){var boundRect=getCanvas().getBoundingClientRect();return[boundRect.left,boundRect.top]};var getSurface=exports.getSurface=function(dimensions){if(null===SURFACE){var canvas=getCanvas();void 0===dimensions&&(dimensions=[canvas.clientWidth,canvas.clientHeight]),SURFACE=new Surface(dimensions),SURFACE._canvas=canvas,SURFACE._canvas.width=dimensions[0],SURFACE._canvas.height=dimensions[1],SURFACE._context=canvas.getContext("2d"),_flags&DISABLE_SMOOTHING?SURFACE._noSmooth():SURFACE._smooth()}return SURFACE}}},["gamejs/graphics","gamejs/event"]),require.define({"gamejs/event":function(require,exports){var display=require("./display"),_CALLBACKS=(require("./utils/callback").Callback,[]),_triggerCallbacks=exports._triggerCallbacks=function(){var args=arguments;_CALLBACKS.forEach(function(cb){("all"===cb.type||args[0].type===cb.type)&&cb.callback.apply(cb.scope,args)})};exports.onFullscreen=function(callback,scope){if("function"!=typeof callback)throw new Error("Callback must be a function");_CALLBACKS.push({callback:callback,scope:scope,type:exports.DISPLAY_FULLSCREEN_ENABLED}),_CALLBACKS.push({callback:callback,scope:scope,type:exports.DISPLAY_FULLSCREEN_DISABLED})},exports.onEvent=function(callback,scope){if("function"!=typeof callback)throw new Error("Callback must be a function");_CALLBACKS.push({callback:callback,scope:scope,type:"all"})},exports.onDisplayResize=function(callback,scope){if("function"!=typeof callback)throw new Error("Callback must be a function");_CALLBACKS.push({callback:callback,scope:scope,type:exports.DISPLAY_RESIZE})},exports.onMouseMotion=function(callback,scope){if("function"!=typeof callback)throw new Error("Callback must be a function");_CALLBACKS.push({callback:callback,scope:scope,type:exports.MOUSE_MOTION})},exports.onMouseUp=function(callback,scope){if("function"!=typeof callback)throw new Error("Callback must be a function");_CALLBACKS.push({callback:callback,scope:scope,type:exports.MOUSE_UP})},exports.onMouseDown=function(callback,scope){if("function"!=typeof callback)throw new Error("Callback must be a function");_CALLBACKS.push({callback:callback,scope:scope,type:exports.MOUSE_DOWN})},exports.onTouchMotion=function(callback,scope){if("function"!=typeof callback)throw new Error("Callback must be a function");_CALLBACKS.push({callback:callback,scope:scope,type:exports.TOUCH_MOTION})},exports.onTouchUp=function(callback,scope){if("function"!=typeof callback)throw new Error("Callback must be a function");_CALLBACKS.push({callback:callback,scope:scope,type:exports.TOUCH_UP})},exports.onTouchDown=function(callback,scope){if("function"!=typeof callback)throw new Error("Callback must be a function");_CALLBACKS.push({callback:callback,scope:scope,type:exports.TOUCH_DOWN})},exports.onKeyDown=function(callback,scope){if("function"!=typeof callback)throw new Error("Callback must be a function");_CALLBACKS.push({callback:callback,scope:scope,type:exports.KEY_DOWN})},exports.onKeyUp=function(callback,scope){if("function"!=typeof callback)throw new Error("Callback must be a function");_CALLBACKS.push({callback:callback,scope:scope,type:exports.KEY_UP})},exports.K_UP=38,exports.K_DOWN=40,exports.K_RIGHT=39,exports.K_LEFT=37,exports.K_SPACE=32,exports.K_BACKSPACE=8,exports.K_TAB=9,exports.K_ENTER=13,exports.K_SHIFT=16,exports.K_CTRL=17,exports.K_ALT=18,exports.K_ESC=27,exports.K_0=48,exports.K_1=49,exports.K_2=50,exports.K_3=51,exports.K_4=52,exports.K_5=53,exports.K_6=54,exports.K_7=55,exports.K_8=56,exports.K_9=57,exports.K_a=65,exports.K_b=66,exports.K_c=67,exports.K_d=68,exports.K_e=69,exports.K_f=70,exports.K_g=71,exports.K_h=72,exports.K_i=73,exports.K_j=74,exports.K_k=75,exports.K_l=76,exports.K_m=77,exports.K_n=78,exports.K_o=79,exports.K_p=80,exports.K_q=81,exports.K_r=82,exports.K_s=83,exports.K_t=84,exports.K_u=85,exports.K_v=86,exports.K_w=87,exports.K_x=88,exports.K_y=89,exports.K_z=90,exports.K_KP1=97,exports.K_KP2=98,exports.K_KP3=99,exports.K_KP4=100,exports.K_KP5=101,exports.K_KP6=102,exports.K_KP7=103,exports.K_KP8=104,exports.K_KP9=105,exports.NOEVENT=0,exports.NUMEVENTS=32e3,exports.DISPLAY_FULLSCREEN_ENABLED=300,exports.DISPLAY_FULLSCREEN_DISABLED=301,exports.DISPLAY_RESIZE=302,exports.QUIT=0,exports.KEY_DOWN=1,exports.KEY_UP=2,exports.MOUSE_MOTION=3,exports.MOUSE_UP=4,exports.MOUSE_DOWN=5,exports.MOUSE_WHEEL=6,exports.TOUCH_UP=7,exports.TOUCH_DOWN=8,exports.TOUCH_MOTION=9,exports.USEREVENT=2e3,exports.Event=function(){this.type=null,this.key=null,this.rel=null,this.button=null,this.pos=null},exports.init=function(){function onMouseDown(ev){var canvasOffset=display._getCanvasOffset();_triggerCallbacks({type:exports.MOUSE_DOWN,pos:[ev.clientX-canvasOffset[0],ev.clientY-canvasOffset[1]],button:ev.button,shiftKey:ev.shiftKey,ctrlKey:ev.ctrlKey,metaKey:ev.metaKey})}function onMouseUp(ev){var canvasOffset=display._getCanvasOffset();_triggerCallbacks({type:exports.MOUSE_UP,pos:[ev.clientX-canvasOffset[0],ev.clientY-canvasOffset[1]],button:ev.button,shiftKey:ev.shiftKey,ctrlKey:ev.ctrlKey,metaKey:ev.metaKey})}function onKeyDown(ev){var key=ev.keyCode||ev.which;_triggerCallbacks({type:exports.KEY_DOWN,key:key,shiftKey:ev.shiftKey,ctrlKey:ev.ctrlKey,metaKey:ev.metaKey}),(display._hasFocus()&&!ev.ctrlKey&&!ev.metaKey&&(key>=exports.K_LEFT&&key<=exports.K_DOWN||key>=exports.K_0&&key<=exports.K_z||key>=exports.K_KP1&&key<=exports.K_KP9||key===exports.K_SPACE||key===exports.K_TAB||key===exports.K_ENTER)||key===exports.K_ALT||key===exports.K_BACKSPACE)&&ev.preventDefault()}function onKeyUp(ev){_triggerCallbacks({type:exports.KEY_UP,key:ev.keyCode,shiftKey:ev.shiftKey,ctrlKey:ev.ctrlKey,metaKey:ev.metaKey})}function onMouseMove(ev){var canvasOffset=display._getCanvasOffset(),currentPos=[ev.clientX-canvasOffset[0],ev.clientY-canvasOffset[1]],relativePos=[];lastPos.length&&(relativePos=[lastPos[0]-currentPos[0],lastPos[1]-currentPos[1]]),_triggerCallbacks({type:exports.MOUSE_MOTION,pos:currentPos,rel:relativePos,buttons:null,timestamp:ev.timeStamp,movement:[ev.movementX||ev.mozMovementX||ev.webkitMovementX||0,ev.movementY||ev.mozMovementY||ev.webkitMovementY||0]}),lastPos=currentPos}function onMouseScroll(ev){var canvasOffset=display._getCanvasOffset(),currentPos=[ev.clientX-canvasOffset[0],ev.clientY-canvasOffset[1]];_triggerCallbacks({type:exports.MOUSE_WHEEL,pos:currentPos,delta:ev.detail||-ev.wheelDeltaY/40})}function onBeforeUnload(){_triggerCallbacks({type:exports.QUIT})}function w3cTouchConvert(touchList){for(var canvasOffset=display._getCanvasOffset(),tList=[],i=0;i<touchList.length;i++){var touchEvent=touchList.item(i);tList.push({identifier:touchEvent.identifier,pos:[touchEvent.clientX-canvasOffset[0],touchEvent.clientY-canvasOffset[1]]})
}return tList}function onTouchDown(ev){var changedTouches=(display._getCanvasOffset(),w3cTouchConvert(ev.changedTouches));_triggerCallbacks({type:exports.TOUCH_DOWN,touches:changedTouches})}function onTouchUp(ev){var changedTouches=w3cTouchConvert(ev.changedTouches);_triggerCallbacks({type:exports.TOUCH_UP,touches:changedTouches})}function onTouchMotion(ev){var changedTouches=w3cTouchConvert(ev.changedTouches);_triggerCallbacks({type:exports.TOUCH_MOTION,touches:changedTouches}),ev.preventDefault()}var lastPos=[],canvas=display._getCanvas();document.addEventListener("mousedown",onMouseDown,!1),document.addEventListener("mouseup",onMouseUp,!1),document.addEventListener("keydown",onKeyDown,!1),document.addEventListener("keyup",onKeyUp,!1),document.addEventListener("mousemove",onMouseMove,!1),canvas.addEventListener("mousewheel",onMouseScroll,!1),canvas.addEventListener("DOMMouseScroll",onMouseScroll,!1),canvas.addEventListener("beforeunload",onBeforeUnload,!1),canvas.addEventListener("touchstart",onTouchDown,!1),canvas.addEventListener("touchend",onTouchUp,!1),canvas.addEventListener("touchcancel",onTouchUp,!1),canvas.addEventListener("touchleave",onTouchUp,!1),canvas.addEventListener("touchmove",onTouchMotion,!1)}}},["gamejs/display","gamejs/utils/callback"]),require.define({"gamejs/font":function(require,exports){var Surface=require("./graphics").Surface,objects=require("./utils/objects"),Font=exports.Font=function(fontSettings,backgroundColor){return this.sampleSurface=new Surface([10,10]),this.sampleSurface.context.font=fontSettings,this.sampleSurface.context.textAlign="start",this.sampleSurface.context.textBaseline="bottom",this.backgroundColor=backgroundColor||!1,this};Font.prototype.render=function(text,color){var dims=this.size(text),surface=new Surface(dims),ctx=surface.context;return ctx.save(),this.backgroundColor&&(ctx.fillStyle=this.backgroundColor,ctx.fillRect(0,0,surface.rect.width,surface.rect.height)),ctx.font=this.sampleSurface.context.font,ctx.textBaseline=this.sampleSurface.context.textBaseline,ctx.textAlign=this.sampleSurface.context.textAlign,ctx.fillStyle=ctx.strokeStyle=color||"#000000",ctx.fillText(text,0,surface.rect.height,surface.rect.width),ctx.restore(),surface},Font.prototype.size=function(text){var metrics=this.sampleSurface.context.measureText(text);return[metrics.width,this.fontHeight]},objects.accessors(Font.prototype,{fontHeight:{get:function(){return 1.5*this.sampleSurface.context.measureText("M").width}}})}},["gamejs/graphics","gamejs/utils/objects"]),require.define({"gamejs/graphics":function(require,exports){var gamejs=require("../gamejs"),Rect=gamejs.Rect,objects=require("./utils/objects"),matrix=require("./math/matrix"),vectors=require("./math/vectors"),Surface=exports.Surface=function(){var args=gamejs.normalizeRectArguments.apply(this,arguments),width=args.left,height=args.top;return 1==arguments.length&&arguments[0]instanceof Rect&&(width=args.width,height=args.height),this._matrix=matrix.identity(),this._canvas=document.createElement("canvas"),this._canvas.width=width,this._canvas.height=height,this._blitAlpha=1,this._context=this._canvas.getContext("2d"),gamejs.display._isSmoothingEnabled()?this._smooth():this._noSmooth(),this};Surface.prototype._noSmooth=function(){this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1},Surface.prototype._smooth=function(){this.context.mozImageSmoothingEnabled=!0,this.context.webkitImageSmoothingEnabled=!0},Surface.prototype.blit=function(src,dest,area,compositeOperation){var rDest,rArea;if(dest instanceof Rect){rDest=dest.clone();var srcSize=src.getSize();rDest.width||(rDest.width=srcSize[0]),rDest.height||(rDest.height=srcSize[1])}else rDest=dest&&dest instanceof Array&&2==dest.length?new Rect(dest,src.getSize()):new Rect([0,0],src.getSize());if(compositeOperation=compositeOperation||"source-over",area instanceof Rect)rArea=area;else if(area&&area instanceof Array&&2==area.length){var size=src.getSize();rArea=new Rect(area,[size[0]-area[0],size[1]-area[1]])}else rArea=new Rect([0,0],src.getSize());if(isNaN(rDest.left)||isNaN(rDest.top)||isNaN(rDest.width)||isNaN(rDest.height))throw new Error("[blit] bad parameters, destination is "+rDest);this.context.save(),this.context.globalCompositeOperation=compositeOperation;var m=matrix.translate(matrix.identity(),rDest.left,rDest.top);m=matrix.multiply(m,src._matrix),this.context.transform(m[0],m[1],m[2],m[3],m[4],m[5]),this.context.globalAlpha=src._blitAlpha,this.context.drawImage(src.canvas,rArea.left,rArea.top,rArea.width,rArea.height,0,0,rDest.width,rDest.height),this.context.restore()},Surface.prototype.getSize=function(){return[this.canvas.width,this.canvas.height]},Surface.prototype.getRect=function(){return new Rect([0,0],this.getSize())},Surface.prototype.fill=function(color,rect){this.context.save(),this.context.fillStyle=color||"#000000",void 0===rect&&(rect=new Rect(0,0,this.canvas.width,this.canvas.height)),this.context.fillRect(rect.left,rect.top,rect.width,rect.height),this.context.restore()},Surface.prototype.clear=function(rect){var size=this.getSize();rect=rect||new Rect(0,0,size[0],size[1]),this.context.clearRect(rect.left,rect.top,rect.width,rect.height)},objects.accessors(Surface.prototype,{rect:{get:function(){return this.getRect()}},context:{get:function(){return this._context}},canvas:{get:function(){return this._canvas}}}),Surface.prototype.clone=function(){var newSurface=new Surface(this.getRect());return newSurface.blit(this),newSurface},Surface.prototype.getAlpha=function(){return 1-this._blitAlpha},Surface.prototype.setAlpha=function(alpha){return isNaN(alpha)||0>alpha||alpha>1?void 0:(this._blitAlpha=1-alpha,1-this._blitAlpha)},Surface.prototype.getImageData=function(){var size=this.getSize();return this.context.getImageData(0,0,size[0],size[1])},exports.line=function(surface,color,startPos,endPos,width){var ctx=surface.context;ctx.save(),ctx.beginPath(),ctx.strokeStyle=color,ctx.lineWidth=width||1,ctx.moveTo(startPos[0],startPos[1]),ctx.lineTo(endPos[0],endPos[1]),ctx.stroke(),ctx.restore()},exports.lines=function(surface,color,closed,pointlist,width){closed=closed||!1;var ctx=surface.context;ctx.save(),ctx.beginPath(),ctx.strokeStyle=ctx.fillStyle=color,ctx.lineWidth=width||1,pointlist.forEach(function(point,idx){0===idx?ctx.moveTo(point[0],point[1]):ctx.lineTo(point[0],point[1])}),closed&&ctx.lineTo(pointlist[0][0],pointlist[0][1]),ctx.stroke(),ctx.restore()},exports.circle=function(surface,color,pos,radius,width){if(isNaN(radius))throw new Error("[circle] radius required argument");if(!(pos&&pos instanceof Array))throw new Error("[circle] pos must be given & array"+pos);var ctx=surface.context;ctx.save(),ctx.beginPath(),ctx.strokeStyle=ctx.fillStyle=color,ctx.lineWidth=width||1,ctx.arc(pos[0],pos[1],radius,0,2*Math.PI,!0),void 0===width||0===width?ctx.fill():ctx.stroke(),ctx.restore()},exports.rect=function(surface,color,rect,width){var ctx=surface.context;ctx.save(),ctx.beginPath(),ctx.strokeStyle=ctx.fillStyle=color,isNaN(width)||0===width?ctx.fillRect(rect.left,rect.top,rect.width,rect.height):(ctx.lineWidth=width||1,ctx.strokeRect(rect.left,rect.top,rect.width,rect.height)),ctx.restore()},exports.arc=function(surface,color,pos,startAngle,stopAngle,radius,width){var ctx=surface.context;ctx.save(),ctx.beginPath(),ctx.strokeStyle=ctx.fillStyle=color,ctx.arc(pos[0],pos[1],radius,startAngle,stopAngle,!1),isNaN(width)||0===width?ctx.fill():(ctx.lineWidth=width||1,ctx.stroke()),ctx.restore()},exports.polygon=function(surface,color,pointlist,width){var ctx=surface.context;ctx.save(),ctx.fillStyle=ctx.strokeStyle=color,ctx.beginPath(),pointlist.forEach(function(point,idx){0===idx?ctx.moveTo(point[0],point[1]):ctx.lineTo(point[0],point[1])}),ctx.closePath(),isNaN(width)||0===width?ctx.fill():(ctx.lineWidth=width||1,ctx.stroke()),ctx.restore()},exports.quadraticCurve=function(surface,color,startPos,endPos,controlPos,width){if(!(startPos&&startPos instanceof Array))throw new Error("[quadratic_curve] startPos must be defined!");if(!(endPos&&endPos instanceof Array))throw new Error("[quadratic_curve] endPos must be defined!");if(!(controlPos&&controlPos instanceof Array))throw new Error("[quadratic_curve] controlPos must be defined!");var ctx=surface.context;ctx.save(),ctx.fillStyle=ctx.strokeStyle=color,ctx.lineWidth=width||1,ctx.beginPath(),ctx.moveTo(startPos[0],startPos[1]),ctx.quadraticCurveTo(controlPos[0],controlPos[1],endPos[0],endPos[1]),ctx.stroke(),ctx.restore()},exports.bezierCurve=function(surface,color,startPos,endPos,ct1Pos,ct2Pos,width){if(!(startPos&&startPos instanceof Array))throw new Error("[bezier_curve] startPos must be defined!");if(!(endPos&&endPos instanceof Array))throw new Error("[bezier_curve] endPos must be defined!");if(!(ct1Pos&&ct1Pos instanceof Array))throw new Error("[bezier_curve] ct1Pos must be defined!");if(!(ct2Pos&&ct2Pos instanceof Array))throw new Error("[bezier_curve] ct2Pos must be defined!");var ctx=surface.context;ctx.save(),ctx.fillStyle=ctx.strokeStyle=color,ctx.lineWidth=width||1,ctx.beginPath(),ctx.moveTo(startPos[0],startPos[1]),ctx.bezierCurveTo(ct1Pos[0],ct1Pos[1],ct2Pos[0],ct2Pos[1],endPos[0],endPos[1]),ctx.stroke(),ctx.restore()},Surface.prototype.rotate=function(angle){var origSize=this.getSize(),radians=angle*Math.PI/180,newSize=origSize;if(angle%360!==0){var rect=this.getRect(),points=[[-rect.width/2,rect.height/2],[rect.width/2,rect.height/2],[-rect.width/2,-rect.height/2],[rect.width/2,-rect.height/2]],rotPoints=points.map(function(p){return vectors.rotate(p,radians)}),xs=rotPoints.map(function(p){return p[0]}),ys=rotPoints.map(function(p){return p[1]}),left=Math.min.apply(Math,xs),right=Math.max.apply(Math,xs),bottom=Math.min.apply(Math,ys),top=Math.max.apply(Math,ys);newSize=[right-left,top-bottom]}var newSurface=new Surface(newSize),oldMatrix=this._matrix;this._matrix=matrix.translate(this._matrix,origSize[0]/2,origSize[1]/2),this._matrix=matrix.rotate(this._matrix,radians),this._matrix=matrix.translate(this._matrix,-origSize[0]/2,-origSize[1]/2);var offset=[(newSize[0]-origSize[0])/2,(newSize[1]-origSize[1])/2];return newSurface.blit(this,offset),this._matrix=oldMatrix,newSurface},Surface.prototype.scale=function(dims){var width=dims[0],height=dims[1];if(0>=width||0>=height)throw new Error("[gamejs.transform.scale] Invalid arguments for height and width",[width,height]);var oldDims=this.getSize(),ws=width/oldDims[0],hs=height/oldDims[1],newSurface=new Surface([width,height]),originalMatrix=this._matrix.slice(0);return this._matrix=matrix.scale(this._matrix,[ws,hs]),newSurface.blit(this),this._matrix=originalMatrix,newSurface},Surface.prototype.flip=function(flipHorizontal,flipVertical){var dims=this.getSize(),newSurface=new Surface(dims),scaleX=1,scaleY=1,xPos=0,yPos=0;return flipHorizontal===!0&&(scaleX=-1,xPos=-dims[0]),flipVertical===!0&&(scaleY=-1,yPos=-dims[1]),newSurface.context.save(),newSurface.context.scale(scaleX,scaleY),newSurface.context.drawImage(this.canvas,xPos,yPos),newSurface.context.restore(),newSurface},exports.blitArray=function(surface,surfaceArray){surface.context.putImageData(surfaceArray.imageData,0,0)};exports.SurfaceArray=function(surfaceOrDimensions){var size=null,data=null,imageData=null;return this.set=function(x,y,rgba){var offset=4*x+y*size[0]*4;data[offset]=rgba[0],data[offset+1]=rgba[1],data[offset+2]=rgba[2],data[offset+3]=void 0===rgba[3]?255:rgba[3]},this.get=function(x,y){var offset=4*x+y*size[0]*4;return[data[offset],data[offset+1],data[offset+2],data[offset+3]]},this.surface=null,objects.accessors(this,{surface:{get:function(){var s=new gamejs.graphics.Surface(size);return s.context.putImageData(imageData,0,0),s}},imageData:{get:function(){return imageData}}}),this.getSize=function(){return size},surfaceOrDimensions instanceof Array?(size=surfaceOrDimensions,imageData=gamejs.display.getSurface().context.createImageData(size[0],size[1]),data=imageData.data):(size=surfaceOrDimensions.getSize(),imageData=surfaceOrDimensions.getImageData(0,0,size[0],size[1]),data=imageData.data),this}}},["gamejs","gamejs/utils/objects","gamejs/math/matrix","gamejs/math/vectors"]),require.define({"gamejs/http":function(require,exports,module){function stringify(response){return eval("("+response.responseText+")")}function ajaxBaseHref(){return window.$g&&window.$g.ajaxBaseHref||"./"}exports.Response=function(){throw this.getResponseHeader=function(){},new Error("response class not instantiable")};var ajax=exports.ajax=function(method,url,data,type){data=data||null;var response=new XMLHttpRequest;return response.open(method,url,!1),type&&response.setRequestHeader("Accept",type),data instanceof Object&&(data=JSON.stringify(data),response.setRequestHeader("Content-Type","application/json")),response.setRequestHeader("X-Requested-With","XMLHttpRequest"),response.send(data),response},get=exports.get=function(url){return ajax("GET",url)},post=exports.post=function(url,data,type){return ajax("POST",url,data,type)};exports.load=function(url){return stringify(get(ajaxBaseHref()+url))},exports.save=function(url,data,type){return stringify(post(ajaxBaseHref()+url,{payload:data},type))}}},[]),require.define({"gamejs/image":function(require,exports){var gamejs=require("../gamejs"),CACHE={},_PRELOADING=!1;exports.load=function(key){var img;if("string"==typeof key){if(img=CACHE[key],!img)throw new Error('Missing "'+key+'", gamejs.preload() all images before trying to load them.')}else img=key;var canvas=document.createElement("canvas");canvas.width=img.naturalWidth||img.width,canvas.height=img.naturalHeight||img.height;var context=canvas.getContext("2d");context.drawImage(img,0,0),img.getSize=function(){return[img.naturalWidth,img.naturalHeight]};var surface=new gamejs.graphics.Surface(img.getSize());return surface._canvas=canvas,surface._context=context,surface},exports.init=function(){},exports.preload=function(imgIdents){function incrementLoaded(){countLoaded++,countLoaded==countTotal&&(_PRELOADING=!1),countLoaded%10===0&&gamejs.logging.debug("gamejs.image: preloaded  "+countLoaded+" of "+countTotal)}function getProgress(){return countTotal>0?countLoaded/countTotal:1}function successHandler(){addToCache(this),incrementLoaded()}function errorHandler(){throw incrementLoaded(),new Error("Error loading "+this.src)}var key,countLoaded=0,countTotal=0;for(key in imgIdents){var lowerKey=key.toLowerCase();if(-1!=lowerKey.indexOf(".png")||-1!=lowerKey.indexOf(".jpg")||-1!=lowerKey.indexOf(".jpeg")||-1!=lowerKey.indexOf(".svg")||-1!=lowerKey.indexOf(".gif")){var img=new Image;img.addEventListener("load",successHandler,!0),img.addEventListener("error",errorHandler,!0),img.src=imgIdents[key],img.gamejsKey=key,countTotal++}}return countTotal>0&&(_PRELOADING=!0),getProgress};var addToCache=function(img){CACHE[img.gamejsKey]=img}}},["gamejs"]),require.define({"gamejs/logging":function(require,exports){var DEBUG_LEVELS=["debug","info","warn","error","fatal"],debugLevel=2,gamejs=require("../gamejs");exports.setLogLevel=function(logLevel){if("string"==typeof logLevel&&DEBUG_LEVELS.indexOf(logLevel))debugLevel=DEBUG_LEVELS.indexOf(logLevel);else{if("number"!=typeof logLevel)throw new Error("invalid logLevel ",logLevel," Must be one of: ",DEBUG_LEVELS);debugLevel=logLevel}return debugLevel};var log=exports.log=function(){if(gamejs.thread.inWorker===!0)return void gamejs.thread._logMessage.apply(null,arguments);var args=Array.prototype.slice.apply(arguments,[0]);args.unshift(Date.now()),void 0!==window.console&&console.log.apply&&console.log.apply(console,args)};exports.debug=function(){debugLevel<=DEBUG_LEVELS.indexOf("debug")&&log.apply(this,arguments)},exports.info=function(){debugLevel<=DEBUG_LEVELS.indexOf("info")&&log.apply(this,arguments)},exports.warn=function(){debugLevel<=DEBUG_LEVELS.indexOf("warn")&&log.apply(this,arguments)},exports.error=function(){debugLevel<=DEBUG_LEVELS.indexOf("error")&&log.apply(this,arguments)},exports.fatal=function(){debugLevel<=DEBUG_LEVELS.indexOf("fatal")&&log.apply(this,arguments)}}},["gamejs"]),require.define({"gamejs/math/angles":function(require,exports){exports.normaliseDegrees=function(degrees){return degrees%=360,0>degrees&&(degrees+=360),degrees},exports.normaliseRadians=function(radians){return radians%=2*Math.PI,0>radians&&(radians+=2*Math.PI),radians},exports.degrees=function(radians){return radians*(180/Math.PI)},exports.radians=function(degrees){return degrees*(Math.PI/180)}}},[]),require.define({"gamejs/math/binaryheap":function(require,exports){var BinaryHeap=exports.BinaryHeap=function(scoreFunction){return this.content=[],this.scoreFunction=scoreFunction,this};BinaryHeap.prototype.push=function(element){this.content.push(element),this.sinkDown(this.content.length-1)},BinaryHeap.prototype.pop=function(){var result=this.content[0],end=this.content.pop();return this.content.length>0&&(this.content[0]=end,this.bubbleUp(0)),result},BinaryHeap.prototype.remove=function(node){var isFound=this.content.some(function(cNode,idx){if(cNode==node){var end=this.content.pop();return idx!=this.content.length&&(this.content[idx]=end,this.scoreFunction(end)<this.scoreFunction(node)?this.sinkDown(idx):this.bubbleUp(idx)),!0}return!1},this);return isFound},BinaryHeap.prototype.size=function(){return this.content.length},BinaryHeap.prototype.sinkDown=function(idx){for(var element=this.content[idx];idx>0;){var parentIdx=Math.floor((idx+1)/2)-1,parent=this.content[parentIdx];if(!(this.scoreFunction(element)<this.scoreFunction(parent)))break;this.content[parentIdx]=element,this.content[idx]=parent,idx=parentIdx}},BinaryHeap.prototype.bubbleUp=function(idx){for(var length=this.content.length,element=this.content[idx],elemScore=this.scoreFunction(element);;){var child1Score,child2Idx=2*(idx+1),child1Idx=child2Idx-1,swapIdx=null;if(length>child1Idx){var child1=this.content[child1Idx];child1Score=this.scoreFunction(child1),elemScore>child1Score&&(swapIdx=child1Idx)}if(length>child2Idx){var child2=this.content[child2Idx],child2Score=this.scoreFunction(child2);(null===swapIdx?elemScore:child1Score)>child2Score&&(swapIdx=child2Idx)}if(null===swapIdx)break;this.content[idx]=this.content[swapIdx],this.content[swapIdx]=element,idx=swapIdx}}}},[]),require.define({"gamejs/math/matrix":function(require,exports){{var multiply=(exports.identity=function(){return[1,0,0,1,0,0]},exports.add=function(m1,m2){return[m1[0]+m2[0],m1[1]+m2[1],m1[2]+m2[2],m1[3]+m2[3],m1[4]+m2[4],m1[5]+m2[5],m1[6]+m2[6]]},exports.multiply=function(m1,m2){return[m1[0]*m2[0]+m1[2]*m2[1],m1[1]*m2[0]+m1[3]*m2[1],m1[0]*m2[2]+m1[2]*m2[3],m1[1]*m2[2]+m1[3]*m2[3],m1[0]*m2[4]+m1[2]*m2[5]+m1[4],m1[1]*m2[4]+m1[3]*m2[5]+m1[5]]});exports.translate=function(m1,dx,dy){return multiply(m1,[1,0,0,1,dx,dy])},exports.rotate=function(m1,angle){var sin=Math.sin(angle),cos=Math.cos(angle);return multiply(m1,[cos,sin,-sin,cos,0,0])},exports.rotation=function(m1){return Math.atan2(m1[1],m1[0])},exports.scale=function(m1,svec){var sx=svec[0],sy=svec[1];return multiply(m1,[sx,0,0,sy,0,0])}}}},[]),require.define({"gamejs/math/noise":function(require,exports){var Simplex=exports.Simplex=function(r){void 0===r&&(r=Math),this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.p=[];var i;for(i=0;256>i;i++)this.p[i]=Math.floor(256*r.random());for(this.perm=[],i=0;512>i;i++)this.perm[i]=this.p[255&i];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]};Simplex.prototype.dot=function(g,x,y){return g[0]*x+g[1]*y},Simplex.prototype.get=function(xin,yin){var n0,n1,n2,i1,j1,F2=.5*(Math.sqrt(3)-1),s=(xin+yin)*F2,i=Math.floor(xin+s),j=Math.floor(yin+s),G2=(3-Math.sqrt(3))/6,t=(i+j)*G2,X0=i-t,Y0=j-t,x0=xin-X0,y0=yin-Y0;x0>y0?(i1=1,j1=0):(i1=0,j1=1);var x1=x0-i1+G2,y1=y0-j1+G2,x2=x0-1+2*G2,y2=y0-1+2*G2,ii=255&i,jj=255&j,gi0=this.perm[ii+this.perm[jj]]%12,gi1=this.perm[ii+i1+this.perm[jj+j1]]%12,gi2=this.perm[ii+1+this.perm[jj+1]]%12,t0=.5-x0*x0-y0*y0;0>t0?n0=0:(t0*=t0,n0=t0*t0*this.dot(this.grad3[gi0],x0,y0));var t1=.5-x1*x1-y1*y1;0>t1?n1=0:(t1*=t1,n1=t1*t1*this.dot(this.grad3[gi1],x1,y1));var t2=.5-x2*x2-y2*y2;return 0>t2?n2=0:(t2*=t2,n2=t2*t2*this.dot(this.grad3[gi2],x2,y2)),70*(n0+n1+n2)},Simplex.prototype.get3d=function(xin,yin,zin){var n0,n1,n2,n3,i1,j1,k1,i2,j2,k2,F3=1/3,s=(xin+yin+zin)*F3,i=Math.floor(xin+s),j=Math.floor(yin+s),k=Math.floor(zin+s),G3=1/6,t=(i+j+k)*G3,X0=i-t,Y0=j-t,Z0=k-t,x0=xin-X0,y0=yin-Y0,z0=zin-Z0;x0>=y0?y0>=z0?(i1=1,j1=0,k1=0,i2=1,j2=1,k2=0):x0>=z0?(i1=1,j1=0,k1=0,i2=1,j2=0,k2=1):(i1=0,j1=0,k1=1,i2=1,j2=0,k2=1):z0>y0?(i1=0,j1=0,k1=1,i2=0,j2=1,k2=1):z0>x0?(i1=0,j1=1,k1=0,i2=0,j2=1,k2=1):(i1=0,j1=1,k1=0,i2=1,j2=1,k2=0);var x1=x0-i1+G3,y1=y0-j1+G3,z1=z0-k1+G3,x2=x0-i2+2*G3,y2=y0-j2+2*G3,z2=z0-k2+2*G3,x3=x0-1+3*G3,y3=y0-1+3*G3,z3=z0-1+3*G3,ii=255&i,jj=255&j,kk=255&k,gi0=this.perm[ii+this.perm[jj+this.perm[kk]]]%12,gi1=this.perm[ii+i1+this.perm[jj+j1+this.perm[kk+k1]]]%12,gi2=this.perm[ii+i2+this.perm[jj+j2+this.perm[kk+k2]]]%12,gi3=this.perm[ii+1+this.perm[jj+1+this.perm[kk+1]]]%12,t0=.6-x0*x0-y0*y0-z0*z0;0>t0?n0=0:(t0*=t0,n0=t0*t0*this.dot(this.grad3[gi0],x0,y0,z0));var t1=.6-x1*x1-y1*y1-z1*z1;0>t1?n1=0:(t1*=t1,n1=t1*t1*this.dot(this.grad3[gi1],x1,y1,z1));var t2=.6-x2*x2-y2*y2-z2*z2;0>t2?n2=0:(t2*=t2,n2=t2*t2*this.dot(this.grad3[gi2],x2,y2,z2));var t3=.6-x3*x3-y3*y3-z3*z3;return 0>t3?n3=0:(t3*=t3,n3=t3*t3*this.dot(this.grad3[gi3],x3,y3,z3)),32*(n0+n1+n2+n3)}}},["gamejs/math/random"]),require.define({"gamejs/math/random":function(require,exports){{var Mash=function(){var n=4022871197;return this.hash=function(data){data=data.toString();var i;for(i=0;i<data.length;i++){n+=data.charCodeAt(i);var h=.02519603282416938*n;n=h>>>0,h-=n,h*=n,n=h>>>0,h-=n,n+=4294967296*h}return 2.3283064365386963e-10*(n>>>0)},this.version="Mash 0.9",this},Alea=exports.Alea=function(){var args=Array.prototype.slice.call(arguments),s0=0,s1=0,s2=0,c=1;0!==args.length&&args[0]||(args=[Date.now()]);var mash=new Mash;s0=mash.hash(" "),s1=mash.hash(" "),s2=mash.hash(" ");var i;for(i=0;i<args.length;i++)s0-=mash.hash(args[i]),0>s0&&(s0+=1),s1-=mash.hash(args[i]),0>s1&&(s1+=1),s2-=mash.hash(args[i]),0>s2&&(s2+=1);return mash=null,this.random=function(){var t=2091639*s0+2.3283064365386963e-10*c;return s0=s1,s1=s2,s2=t-(c=0|t)},this.integer=function(min,max){return min+parseInt(this.random()*(max-min+1),10)},this.vector=function(min,max){return[this.integer(min[0],max[0]),this.integer(min[1],max[1])]},this.choose=function(items){return items[this.integer(0,items.length-1)]},this},alea=null;exports.integer=function(min,max){return alea.integer(min,max)}}exports.vector=function(min,max){return alea.vector(min,max)},exports.choose=function(items){return alea.choose(items)},exports.random=function(){return alea.random()},exports.init=function(seed){alea=new Alea(seed)}}},["gamejs/math/random"]),require.define({"gamejs/math/vectors":function(require,exports){var angles=require("./angles");exports.distance=function(a,b){return len(subtract(a,b))};var subtract=exports.subtract=function(a,b){return[a[0]-b[0],a[1]-b[1]]},multiply=(exports.add=function(a,b){return[a[0]+b[0],a[1]+b[1]]},exports.multiply=function(a,s){return"number"==typeof s?[a[0]*s,a[1]*s]:[a[0]*s[0],a[1]*s[1]]});exports.divide=function(a,s){if("number"==typeof s)return[a[0]/s,a[1]/s];throw new Error("only divide by scalar supported")};var len=exports.len=function(v){return Math.sqrt(v[0]*v[0]+v[1]*v[1])},unit=exports.unit=function(v){var l=len(v);return l?[v[0]/l,v[1]/l]:[0,0]};exports.rotate=function(v,angle){return angle=angles.normaliseRadians(angle),[v[0]*Math.cos(angle)-v[1]*Math.sin(angle),v[0]*Math.sin(angle)+v[1]*Math.cos(angle)]};var dot=exports.dot=function(v1,v2){return v1[0]*v2[0]+v1[1]*v2[1]};exports.angle=function(v1,v2){var perpDot=v1[0]*v2[1]-v1[1]*v2[0];return Math.atan2(perpDot,dot(v1,v2))},exports.truncate=function(v,maxLength){return len(v)>maxLength?multiply(unit(v),maxLength):v},exports.centroid=function(){var args=Array.prototype.slice.apply(arguments,[0]),c=[0,0];args.forEach(function(p){c[0]+=parseInt(p[0],10),c[1]+=parseInt(p[1],10)});var len=args.length;return[c[0]/len,c[1]/len]}}},["gamejs/math/angles"]),require.define({"gamejs/pathfinding":function(require,exports){function ReachedList(hashFn){var list={};return this.store=function(point,route){list[hashFn(point)]=route},this.find=function(point){return list[hashFn(point)]},this}var BinaryHeap=require("./math/binaryheap").BinaryHeap;exports.findRoute=function(map,from,to,timeout){function routeScore(route){return void 0===route.score&&(route.score=map.estimatedDistance(route.point,to)+route.length),route.score}function addOpenRoute(route){open.push(route),reached.store(route.point,route)}function processNewPoints(direction){var known=reached.find(direction),newLength=route.length+map.actualDistance(route.point,direction);(!known||known.length>newLength)&&(known&&open.remove(known),addOpenRoute({point:direction,from:route,length:newLength}))}var open=new BinaryHeap(routeScore),hashFn="function"==typeof map.hash?map.hash:defaultHash,reached=new ReachedList(hashFn),startMs=Date.now(),route=null;addOpenRoute({point:from,from:null,length:0});for(var equalsFn="function"==typeof map.equals?map.equals:defaultEquals;open.size()>0&&(!timeout||Date.now()-startMs<timeout);){if(route=open.pop(),equalsFn(to,route.point))return route;map.adjacent(route.point).forEach(processNewPoints)}return null};var defaultEquals=function(a,b){return a[0]===b[0]&&a[1]===b[1]},defaultHash=function(a){return a[0]+"-"+a[1]},Map=exports.Map=function(){throw new Error("not instantiable, this is an interface")};Map.prototype.adjacent=function(){},Map.prototype.equals=defaultEquals,Map.prototype.hash=defaultHash,Map.prototype.estimatedDistance=function(){return 1},Map.prototype.actualDistance=function(){return 1}}},["gamejs/math/binaryheap"]),require.define({"gamejs/pixelcollision":function(require,exports){var gamejs=require("../gamejs"),objects=require("./utils/objects"),Mask=exports.Mask=function(surface,threshold){this._bits=[],threshold=threshold&&255-threshold||255;var imgData=surface.getImageData().data,dims=surface.getSize();this.width=dims[0],this.height=dims[1];var i,j;for(i=0;i<this.width;i++)for(this._bits[i]=[],j=0;j<this.height;j++)this._bits[i][j]=!1;for(i=0;i<imgData.length;i+=4){var y=parseInt(i/4/dims[0],10),x=parseInt(i/4%dims[0],10),alpha=imgData[i+3];alpha>=threshold&&this.setAt(x,y)}};Mask.prototype.overlapRect=function(otherMask,offset){var arect=this.rect,brect=otherMask.rect;if(offset&&brect.moveIp(offset),!brect.collideRect(arect))return null;var xStart=Math.max(arect.left,brect.left),xEnd=Math.min(arect.right,brect.right),yStart=Math.max(arect.top,brect.top),yEnd=Math.min(arect.bottom,brect.bottom);return new gamejs.Rect([xStart,yStart],[xEnd-xStart,yEnd-yStart])},Mask.prototype.overlap=function(otherMask,offset){var overlapRect=this.overlapRect(otherMask,offset);if(null===overlapRect)return!1;var arect=this.rect,brect=otherMask.rect;offset&&brect.moveIp(offset);var x,y;for(y=overlapRect.top;y<=overlapRect.bottom;y++)for(x=overlapRect.left;x<=overlapRect.right;x++)if(this.getAt(x-arect.left,y-arect.top)&&otherMask.getAt(x-brect.left,y-brect.top))return!0;return!1},Mask.prototype.overlapArea=function(otherMask,offset){var overlapRect=this.overlapRect(otherMask,offset);if(null===overlapRect)return 0;var arect=this.rect,brect=otherMask.rect;offset&&brect.moveIp(offset);var x,y,count=0;for(y=overlapRect.top;y<=overlapRect.bottom;y++)for(x=overlapRect.left;x<=overlapRect.right;x++)this.getAt(x-arect.left,y-arect.top)&&otherMask.getAt(x-brect.left,y-brect.top)&&count++;return count},Mask.prototype.overlapMask=function(otherMask,offset){var overlapRect=this.overlapRect(otherMask,offset);if(null===overlapRect)return 0;var arect=this.rect,brect=otherMask.rect;offset&&brect.moveIp(offset);var x,y,mask=new Mask([overlapRect.width,overlapRect.height]);for(y=overlapRect.top;y<=overlapRect.bottom;y++)for(x=overlapRect.left;x<=overlapRect.right;x++)this.getAt(x-arect.left,y-arect.top)&&otherMask.getAt(x-brect.left,y-brect.top)&&mask.setAt(x,y);return mask},Mask.prototype.setAt=function(x,y){this._bits[x][y]=!0},Mask.prototype.getAt=function(x,y){return x=parseInt(x,10),y=parseInt(y,10),0>x||0>y||x>=this.width||y>=this.height?!1:this._bits[x][y]},Mask.prototype.invert=function(){this._bits=this._bits.map(function(row){return row.map(function(b){return!b})})},Mask.prototype.getSize=function(){return[this.width,this.height]},objects.accessors(Mask.prototype,{rect:{get:function(){return new gamejs.Rect([0,0],[this.width,this.height])}},length:{get:function(){var c=0;return this._bits.forEach(function(row){row.forEach(function(b){b&&c++})}),c}}})}},["gamejs","gamejs/utils/objects"]),require.define({"gamejs/thread":function(require,exports){function guid(moduleId){var S4=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return moduleId+"@"+(S4()+S4())}var gamejs=require("../gamejs"),uri=require("./utils/uri"),Callback=require("./utils/callback").Callback,_EVENTS=exports._EVENTS={RESULT:1001,ALIVE:1002,LOG:1004},inWorker=exports.inWorker=void 0!==this.importScripts;exports._ready=function(){self.onmessage=function(event){gamejs.event._triggerCallbacks(event.data)},self.postMessage({type:_EVENTS.ALIVE})},exports.post=function(data){if(!inWorker)throw new Error("gamejs.postMessage only available in a thread/worker module");self.postMessage({type:_EVENTS.RESULT,data:data})},exports._logMessage=function(){var args=[];Array.prototype.forEach.call(arguments,function(a){args.push(a)}),self.postMessage({type:_EVENTS.LOG,arguments:args})};var workerPrefix=function(){__scripts.forEach(function(script){try{importScripts(script)}catch(e){}})},create=function(workerModuleId){var moduleRoot=uri.resolve(document.location.href,window.require.getModuleRoot()),initialScripts=[];Array.prototype.slice.apply(document.getElementsByTagName("script"),[0]).forEach(function(script){script.src&&initialScripts.push(script.src)});var URL=window.URL||window.webkitURL,prefixString=workerPrefix.toString();prefixString=prefixString.substring(prefixString.indexOf("{")+1,prefixString.lastIndexOf("}"));var blob=new Blob(['var __scripts = ["'+initialScripts.join('","')+'"];',prefixString,';self.require.setModuleRoot("'+moduleRoot+'");','self.require.run("'+workerModuleId+'");'],{type:"application/javascript"}),blobURL=URL.createObjectURL(blob);return new Worker(blobURL)};exports.Worker=function(moduleId){function triggerCallbacks(callbacks,event){callbacks.forEach(function(c){c.trigger(event)})}var id=this.id=guid(moduleId),worker=create(moduleId),deadQueue=[],alive=!1,self=this,_CALLBACKS=[],_ERROR_CALLBACKS=[];return worker.onmessage=function(event){event.data.type===_EVENTS.ALIVE?(alive=!0,deadQueue.forEach(function(data){self.post(data)})):event.data.type===_EVENTS.LOG?gamejs.logging.log.apply(null,[id].concat(event.data.arguments)):triggerCallbacks(_CALLBACKS,event.data.data)},worker.onerror=function(event){gamejs.logging.error('Error in worker "'+id+'" line '+event.lineno+": ",event.message),triggerCallbacks(_ERROR_CALLBACKS,{data:event.data,worker:self,event:event})},this.onEvent=function(fn,scope){_CALLBACKS.push(new Callback(fn,scope))},this.onError=function(fn,scope){_ERROR_CALLBACKS.push(new Callback(fn,scope))},this.post=function(data){alive?worker.postMessage(data):deadQueue.push(data)
},this}}},["gamejs","gamejs/utils/uri","gamejs/utils/callback","gamejs"]),require.define({"gamejs/tiledmap":function(require,exports){var gamejs=require("../gamejs"),xml=(require("./utils/objects"),require("./utils/xml")),base64=require("./utils/base64"),uri=require("./utils/uri"),TileSets=(exports.Map=function(url){url=uri.resolve(document.location.href,url);var xmlDoc=xml.Document.fromURL(url),mapNode=xmlDoc.element("map");this.tileWidth=mapNode.attribute("tilewidth"),this.tileHeight=mapNode.attribute("tileheight"),this.width=mapNode.attribute("width"),this.height=mapNode.attribute("height");var orientation=mapNode.attribute("orientation");if("orthogonal"!==orientation)throw new Error("only orthogonol maps supported");return this.properties={},setProperties(this.properties,mapNode),this.tiles=new TileSets(mapNode,url),this.layers=loadLayers(mapNode),this},exports.Tile=function(){throw this.surface=null,this.properties=null,new Error("Can not be instantiated.")},exports.TileSets=function(mapNode,mapUrl){var tileSets=[];this.getSurface=function(gid){var tile=this.getTile(gid);return tile&&tile.surface||null},this.getProperties=function(gid){var tile=this.getTile(gid);return tile&&tile.properties||{}},this.getTile=function(gid){var tile=null;return tileSets.some(function(tileSet){return tileSet.firstGid<=gid?(tile=tileSet.tiles[gid-tileSet.firstGid],!0):!1},this),tile};var loadTileSet=function(tileSetNode){for(var tiles=[],tileWidth=tileSetNode.attribute("tilewidth"),tileHeight=tileSetNode.attribute("tileheight"),spacing=tileSetNode.attribute("spacing")||0,imageNode=tileSetNode.element("image"),imageAtlasFile=imageNode.attribute("source"),imageUrl=uri.makeRelative(uri.resolve(mapUrl,imageAtlasFile)),atlas=gamejs.image.load(imageUrl),tileNodes=tileSetNode.elements("tile"),dims=atlas.getSize(),imgSize=new gamejs.Rect([0,0],[tileWidth,tileHeight]),idx=0,y=0;y+tileHeight<=dims[1];){for(var x=0;x+tileWidth<=dims[0];){var tileImage=new gamejs.graphics.Surface(tileWidth,tileHeight),rect=new gamejs.Rect([x,y],[tileWidth,tileHeight]);tileImage.blit(atlas,imgSize,rect);var tileProperties={};tileNodes.some(function(tileNode){return tileNode.attribute("id")===idx?(setProperties(tileProperties,tileNode),!0):void 0},this),tiles.push({surface:tileImage,properties:tileProperties}),x+=tileWidth+spacing,idx++}y+=tileHeight+spacing}return tiles};return mapNode.elements("tileset").forEach(function(tileSetNode){var firstGid=tileSetNode.attribute("firstgid"),externalSource=tileSetNode.attribute("source");if(externalSource){var tileSetDocument=xml.Document.fromURL(uri.resolve(mapUrl,externalSource));tileSetNode=tileSetDocument.element("tileset")}tileSets.push({tiles:loadTileSet(tileSetNode),firstGid:firstGid})}),tileSets.reverse(),this}),H_FLIP=2147483648,V_FLIP=1073741824,loadLayers=function(mapNode){var layers=[],getGids=function(layerNode){var dataNode=layerNode.element("data"),encoding=dataNode.attribute("encoding"),compression=dataNode.attribute("compression"),data="";dataNode.children().forEach(function(textNode){data+=textNode.value()});var byteData=[];if("base64"===encoding){if(compression)throw new Error("Compression of map data unsupported");byteData=base64.decodeAsArray(data,4)}else{if("csv"!==encoding)throw new Error("individual tile format not supported");data.trim().split("\n").forEach(function(row){row.split(",",width).forEach(function(entry){byteData.push(parseInt(entry,10))})})}return byteData},width=mapNode.attribute("width"),height=mapNode.attribute("height");return mapNode.elements("layer").forEach(function(layerNode){for(var gidMatrix=[],i=height;i-->0;){var j=width;for(gidMatrix[i]=[];j-->0;)gidMatrix[i][j]=0}getGids(layerNode).forEach(function(gid,idx){gid&=~(H_FLIP|V_FLIP),gidMatrix[parseInt(idx/width,10)][parseInt(idx%width,10)]=gid}),layers.push({gids:gidMatrix,opacity:layerNode.attribute("opacity"),visible:layerNode.attribute("visible"),properties:setProperties({},layerNode)})}),layers},setProperties=function(object,node){var props=node.element("properties");if(props)return props.elements("property").forEach(function(propertyNode){var name=propertyNode.attribute("name"),value=propertyNode.attribute("value");object[name]=value}),object},MapView=exports.MapView=function(map){return this.timeout=0,this.layerViews=map.layers.map(function(layer){return new LayerView(layer,{tileWidth:map.tileWidth,tileHeight:map.tileHeight,width:map.width,height:map.height,tiles:map.tiles})}),this.viewRect=new gamejs.Rect([0,0],[map.width*map.tileWidth,map.height*map.tileWidth]),this.image=new gamejs.graphics.Surface([this.viewRect.width,this.viewRect.height]),this.mapImage=this.image.clone(),this.redraw(),this};MapView.prototype.redraw=function(){this.layerViews.forEach(function(layer){layer.draw(this.mapImage)},this)},MapView.prototype.draw=function(display,offset){display.blit(this.mapImage,offset||[0,0],this.viewRect)};var LayerView=exports.LayerView=function(layer,opts){return this.draw=function(display){display.blit(this.surface)},this.surface=new gamejs.graphics.Surface(opts.width*opts.tileWidth,opts.height*opts.tileHeight),this.surface.setAlpha(layer.opacity),layer.gids.forEach(function(row,i){row.forEach(function(gid,j){if(0!==gid){var tileSurface=opts.tiles.getSurface(gid);tileSurface?this.surface.blit(tileSurface,new gamejs.Rect([j*opts.tileWidth,i*opts.tileHeight],[opts.tileWidth,opts.tileHeight])):gamejs.log("no gid ",gid,i,j,"layer",i)}},this)},this),this}}},["gamejs","gamejs/utils/objects","gamejs/utils/xml","gamejs/utils/base64","gamejs/utils/uri"]),require.define({"gamejs/time":function(require,exports){var TIMER_LASTCALL=(require("./utils/callback").Callback,null),STARTTIME=null,_CALLBACKS=exports._CALLBACKS=[],reqAnimationFrame="undefined"!=typeof window?window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||null:null,reqAniFrameRecursive=function(){perInterval(),reqAnimationFrame(reqAniFrameRecursive)},triggerCallbacks=function(msDuration){_CALLBACKS.forEach(function(c){c.trigger(msDuration)})};exports.init=function(){STARTTIME=Date.now(),reqAnimationFrame?reqAnimationFrame(reqAniFrameRecursive):setInterval(perInterval,10)};var perInterval=function(){var msNow=Date.now();triggerCallbacks(msNow-(TIMER_LASTCALL||msNow)),TIMER_LASTCALL=msNow}}},["gamejs/utils/callback"]),require.define({"gamejs/utils/arrays":function(require,exports){exports.remove=function(item,array){var index=array.indexOf(item);return-1!==index?array.splice(array.indexOf(item),1):null},exports.shuffle=function(array){for(var len=array.length-1,i=len;i>0;i--){var idx=parseInt(Math.random()*(i+1),10),item=array[i];array[i]=array[idx],array[idx]=item}return array}}},[]),require.define({"gamejs/utils/base64":function(require,exports){var keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",decode=exports.decode=function(input){var chr1,chr2,chr3,enc1,enc2,enc3,enc4,output=[],i=0;for(input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");i<input.length;)enc1=keyStr.indexOf(input.charAt(i++)),enc2=keyStr.indexOf(input.charAt(i++)),enc3=keyStr.indexOf(input.charAt(i++)),enc4=keyStr.indexOf(input.charAt(i++)),chr1=enc1<<2|enc2>>4,chr2=(15&enc2)<<4|enc3>>2,chr3=(3&enc3)<<6|enc4,output.push(String.fromCharCode(chr1)),64!=enc3&&output.push(String.fromCharCode(chr2)),64!=enc4&&output.push(String.fromCharCode(chr3));return output=output.join("")};exports.decodeAsArray=function(input,bytes){bytes=bytes||1;var i,j,decoded=decode(input),len=decoded.length/bytes,array=[];for(i=0;len>i;i++)for(array[i]=0,j=bytes-1;j>=0;--j)array[i]+=decoded.charCodeAt(i*bytes+j)<<(j<<3);return array}}},[]),require.define({"gamejs/utils/callback":function(require,exports){var Callback=exports.Callback=function(fn,scope){return this.fn=fn,this.fnScope=scope||{},this};Callback.prototype.trigger=function(){this.fn.apply(this.fnScope,arguments)}}},[]),require.define({"gamejs/utils/objects":function(require,exports){exports.extend=function(subClass,superClass){if(void 0===subClass)throw new Error("unknown subClass");if(void 0===superClass)throw new Error("unknown superClass");var F;F=new Function,F.prototype=superClass.prototype,subClass.prototype=new F,subClass.prototype.constructor=subClass,subClass.superClass=superClass.prototype,subClass.superConstructor=superClass},exports.merge=function(){var i,property,result={};for(i=arguments.length;i>0;--i){var obj=arguments[i-1];for(property in obj)result[property]=obj[property]}return result};var keys=exports.keys=function(obj){if(Object.keys)return Object.keys(obj);var p,ret=[];for(p in obj)Object.prototype.hasOwnProperty.call(obj,p)&&ret.push(p);return ret},accessor=exports.accessor=function(object,name,get,set){void 0!==Object.defineProperty?Object.defineProperty(object,name,{get:get,set:set}):void 0!==Object.prototype.__defineGetter__&&(object.__defineGetter__(name,get),set&&object.__defineSetter__(name,set))};exports.accessors=function(object,props){keys(props).forEach(function(propKey){accessor(object,propKey,props[propKey].get,props[propKey].set)})}}},[]),require.define({"gamejs/utils/strings":function(require,exports){exports.getCommonPrefix=function(str1,str2){if(null===str1||null===str2)return null;if(str1.length>str2.length&&0===str1.indexOf(str2))return str2;if(str2.length>str1.length&&0===str2.indexOf(str1))return str1;var i,length=Math.min(str1.length,str2.length);for(i=0;length>i;i++)if(str1[i]!=str2[i])return str1.slice(0,i);return str1.slice(0,length)}}},[]),require.define({"gamejs/utils/uri":function(require,exports){var URI_REGEX=new RegExp("^(?:([^:/?#.]+):)?(?://(?:([^/?#]*)@)?([\\w\\d\\-\\u0100-\\uffff.%]*)(?::([0-9]+))?)?([^?#]+)?(?:\\?([^#]*))?(?:#(.*))?$"),resolve=exports.resolve=function(uri,path){var m=match(uri),n=match(path),host=m[1]+"://"+m[3];if(n[1])return path;m[4]&&(host=host+":"+m[4]);var absolutePath=m[5];if("/"!==path.charAt(0)){var lastSlashIndex=absolutePath.lastIndexOf("/");absolutePath=absolutePath.substr(0,lastSlashIndex+1)+path}else absolutePath=path;return host+removeDotSegments(absolutePath)},match=exports.match=function(uri){return uri.match(URI_REGEX)},removeDotSegments=(exports.makeRelative=function(uri){var docLocPath=resolve(document.location.href,"./");return 0===uri.indexOf(docLocPath)&&(uri="./"+uri.substring(docLocPath.length)),uri},function(path){if(".."==path||"."==path)return"";var pos,leadingSlash=path.indexOf("/")>-1,segments=path.split("/"),out=[];for(pos=0;pos<segments.length;){var segment=segments[pos++];"."==segment?leadingSlash&&pos==segments.length&&out.push(""):".."==segment?((out.length>1||1!==out.length&&""!==out[0])&&out.pop(),leadingSlash&&pos==segments.length&&out.push("")):(out.push(segment),leadingSlash=!0)}return out.join("/")})}},[]),require.define({"gamejs/utils/xml":function(require,exports){var Document=(exports.Parser=function(){var xmlDoc=null,parser=new DOMParser;return this.parseFromString=function(xmlString){return xmlDoc=parser.parseFromString(xmlString,"text/xml")},this},exports.Document=function(xmlDocument){if(!xmlDocument||!xmlDocument instanceof XMLDocument)throw new Error("Need a valid xmlDocument.");return this._xmlDocument=xmlDocument,this});Document.prototype.element=function(name){var elem=this._xmlDocument.getElementsByTagName(name)[0];return elem&&new Document(elem)||null},Document.prototype.elements=function(name){var elems=this._xmlDocument.getElementsByTagName(name);return Array.prototype.slice.apply(elems,[0]).map(function(elem){return new Document(elem)})},Document.prototype.attribute=function(name){var attributeValue=this._xmlDocument.getAttribute(name);if(attributeValue=attributeValue?attributeValue.trim():null,null===attributeValue)return null;if("true"===attributeValue.toLowerCase())return!0;if("false"===attributeValue.toLowerCase())return!1;var attributeIntValue=parseInt(attributeValue,10),attributeFloatValue=parseFloat(attributeValue,10);return isNaN(attributeIntValue)?attributeValue:attributeFloatValue!==attributeIntValue?attributeFloatValue:attributeIntValue},Document.prototype.value=function(){return this._xmlDocument.nodeValue},Document.prototype.children=function(){return Array.prototype.slice.apply(this._xmlDocument.childNodes,[0]).map(function(cNode){return new Document(cNode)})},Document.fromString=function(xmlString){var parser=new DOMParser,xmlDoc=parser.parseFromString(xmlString,"text/xml");return new Document(xmlDoc)},Document.fromURL=function(url){var response=new XMLHttpRequest;return response.open("GET",url,!1),response.setRequestHeader("X-Requested-With","XMLHttpRequest"),response.setRequestHeader("Content-Type","text/xml"),response.overrideMimeType("text/xml"),response.send(),new Document(response.responseXML)}}},[]);