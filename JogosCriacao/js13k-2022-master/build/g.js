function t(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t+1))+t}!function(t){var e=t.noise={};function i(t,e,i){this.x=t,this.y=e,this.z=i}i.prototype.dot2=function(t,e){return this.x*t+this.y*e},i.prototype.dot3=function(t,e,i){return this.x*t+this.y*e+this.z*i};var h=[new i(1,1,0),new i(-1,1,0),new i(1,-1,0),new i(-1,-1,0),new i(1,0,1),new i(-1,0,1),new i(1,0,-1),new i(-1,0,-1),new i(0,1,1),new i(0,-1,1),new i(0,1,-1),new i(0,-1,-1)],s=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],r=new Array(512),a=new Array(512);function n(t){return t*t*t*(t*(6*t-15)+10)}function l(t,e,i){return(1-i)*t+i*e}e.seed=function(t){t>0&&t<1&&(t*=65536),(t=Math.floor(t))<256&&(t|=t<<8);for(var e=0;e<256;e++){var i;i=1&e?s[e]^255&t:s[e]^t>>8&255,r[e]=r[e+256]=i,a[e]=a[e+256]=h[i%12]}},e.seed(0),e.perlin2=function(t,e){var i=Math.floor(t),h=Math.floor(e);t-=i,e-=h;var s=a[(i&=255)+r[h&=255]].dot2(t,e),o=a[i+r[h+1]].dot2(t,e-1),f=a[i+1+r[h]].dot2(t-1,e),c=a[i+1+r[h+1]].dot2(t-1,e-1),y=n(t);return l(l(s,f,y),l(o,c,y),n(e))}}(this);var e=document.getElementsByTagName("canvas")[0];e.width=240,e.height=160;let i=e.width,h=e.height;var s=e.getContext("2d");e.width,e.height;let r=0,a=0;s.imageSmoothingEnabled=!1,s.mozImageSmoothingEnabled=!1;let n=0,l={},o=[],f=[],c=[],d=[],g=[];function m(){for(let t=0;t<d.length;t++){let e=d[t];if("PTUG"===e.key)return e}}function u(){for(let t=0;t<d.length;t++){let e=d[t];if("PBARGE"==e.key)return e}}function p(t,e,i,h){var s=t-i,r=e-h;return Math.sqrt(s*s+r*r)}let w=0,R=t(8,12),b=t(0,h/8)-R,O=b+R,v=0,A=100,k=[];for(let t=0;t<20;t++)k.push(1e3);let T=0,I=!1,X=null,D=-1;function E(t,e,i,h=1){function s(e,i){t.fillRect(e,i,1,1)}let r,a,n,l=Math.round(e[0]),o=Math.round(e[1]),f=Math.round(i[0]),c=Math.round(i[1]),y=Math.abs(f-l),d=l<f?1:-1,g=Math.abs(c-o),x=o<c?1:-1,m=y-g,u=y+g===0?1:Math.sqrt(y*y+g*g);for(;;){if(s(l,o),r=m,a=l,2*r>=-y){for(r+=g,n=o;r<u*h&&(c!=n||y>g);)s(l,n+=x),r+=y;if(l===f)break;r=m,m-=g,l+=d}if(2*r<=g){for(r=y-r;r<u*h&&(f!=a||y<g);)s(a+=d,o),r+=g;if(o===c)break;m+=y,o+=x}}}function Y(t,e,i){return t<e?e:t>i?i:t}function F(t,e){return t.x<e.x+e.w&&t.x+t.w>e.x&&t.y<e.y+e.h&&t.h+t.y>e.y}function P(t,e){let i=!0,h=noise.perlin2(t/10,e/10);return h<=0&&(i=!1),e>=b&&e<=O&&(i=!1),{canPlace:i,perlin:h}}function C(t){return o[t]??!1}class H{constructor(t={}){this.texture=t.texture,this.x=t.x,this.y=t.y,this.frame=t.frame??0,this.maxFrames=t.maxFrames??1,this.frameOffsetX=t.frameOffsetX??0,this.frameOffsetY=t.frameOffsetY??0,this.frameWidth=t.frameWidth??8,this.frameHeight=t.frameHeight??8,this.sheetOffsetX=t.sheetOffsetX??0,this.sheetOffsetY=t.sheetOffsetY??0,this.isAnimated=t.isAnimated??!1,this.isPlaying=!0,this.loop=t.loop??!1,this.animTick=0,this.animDelay=t.animDelay??100,this.hasAnimationCompleted=!1}update(){this.isAnimated&&this.isPlaying&&(this.animTick<this.animDelay?this.animTick++:(this.frame<this.maxFrames-1?this.frame++:this.loop?this.frame=0:this.hasAnimationCompleted=!0,this.frameOffsetX=this.sheetOffsetX+this.frame*this.frameWidth,this.frameOffsetY=this.sheetOffsetY,this.animTick=0))}render(t){t.drawImage(this.texture,this.sheetOffsetX+this.frameOffsetX,this.sheetOffsetY+this.frameOffsetY,this.frameWidth,this.frameHeight,Math.round(this.x),Math.round(this.y),this.frameWidth,this.frameHeight)}}class M{constructor(t,e,i,h){this.x=t,this.y=e,this.w=i,this.h=h}}class W{constructor(t,e){this.x=t,this.y=e,this.velX=0,this.velY=0,this.hitboxOffsetX=0,this.hitboxOffsetY=0,this.hitbox=new M(0,0,0,0),this.canDestroy=!1}baseUpdate(){this.x+=this.velX,this.y+=this.velY,this.hitbox.x=this.x+this.hitboxOffsetX,this.hitbox.y=this.y+this.hitboxOffsetY}}class S extends W{constructor(t){super(t.x,t.y),t.x=t.x??x,t.y=t.y??y,this.sprite=new H(t),this.key=t.key??"",this.hitbox.w=this.sprite.frameWidth,this.hitbox.h=this.sprite.frameHeight,this.shouldRenderLast=t.shouldRenderLast??!1,this.canHighlight=t.canHighlight??!1,this.highlightRect=new M(0,0,this.sprite.frameWidth,this.sprite.frameHeight),this.highlightState="growing"}update(){this.baseUpdate(),this.sprite.x=this.x,this.sprite.y=this.y,this.sprite.update(),this.highlightRect.x=this.x-.5*(this.highlightRect.w-this.sprite.frameWidth),this.highlightRect.y=this.y-.5*(this.highlightRect.h-this.sprite.frameHeight),this.canHighlight&&("i"===this.highlightState?this.highlightRect.w<this.sprite.frameWidth+6?(this.highlightRect.w+=.1,this.highlightRect.h+=.1):this.highlightState="d":this.highlightRect.w>this.sprite.frameWidth?(this.highlightRect.w-=.1,this.highlightRect.h-=.1):this.highlightState="i")}render(t){this.canHighlight&&this.highlightRect.x>0&&this.highlightRect.y>0&&(t.fillStyle="#a0cf0a",t.fillRect(Math.round(this.highlightRect.x),Math.round(this.highlightRect.y),Math.round(this.highlightRect.w),Math.round(this.highlightRect.h))),this.sprite.render(t)}}class L extends W{constructor(t){super(t.x,t.y),this.destroyOnComplete=t.destroyOnComplete??!1,this.sprite=new H({texture:t.texture,isAnimated:t.isAnimated??!1,maxFrames:t.maxFrames??1,animDelay:t.animDelay??100,x:t.x,y:t.y}),this.hitbox.w=this.sprite.frameWidth,this.hitbox.h=this.sprite.frameHeight}update(){this.baseUpdate(),this.sprite.x=this.x,this.sprite.y=this.y,this.sprite.update(),this.destroyOnComplete&&this.sprite.hasAnimationCompleted&&(this.canDestroy=!0)}render(t){this.sprite.render(t)}}class G extends W{constructor(t,e){super(t,e),this.key="PTUG",this.sprite=new H({texture:l.entities,x:t,y:e}),this.isDead=!1,this.smokeTick=0,this.smokeDelay=15,this.hitboxOffsetX=2,this.hitboxOffsetY=2,this.hitbox.w=this.sprite.frameWidth-4,this.hitbox.h=4}hit(){this.isDead||(D=180,this.isDead=!0,this.canDestroy=!0)}update(){if(this.baseUpdate(),this.x=Y(this.x,0,i-8),this.y=Y(this.y,0,h-8),this.sprite.x=this.x,this.sprite.y=this.y,!this.isDead)if(this.smokeTick<this.smokeDelay)this.smokeTick++;else{for(let e=0;e<3;e++){let e=new L({texture:l.smoke,isAnimated:!0,maxFrames:5,animDelay:4,destroyOnComplete:!0,x:this.x,y:this.y});e.velX=-t(1,2),g.push(e)}this.smokeTick=0}}render(t){this.isDead||this.sprite.render(t)}}class N extends W{constructor(t,e){super(t,e),this.key="PBARGE",this.sprite=new H({texture:l.entities,sheetOffsetX:8,frameWidth:16,x:t,y:e}),this.isDead=!1,this.hitboxOffsetX=2,this.hitboxOffsetY=2,this.hitbox.w=this.sprite.frameWidth-4,this.hitbox.h=this.sprite.frameHeight-4}hit(){this.isDead||(D=180,this.isDead=!0,this.canDestroy=!0)}update(){this.baseUpdate(),this.sprite.x=this.x,this.sprite.y=this.y}render(t){this.isDead||this.sprite.render(t)}}class _ extends W{constructor(t={}){super(t.x,t.y),this.key="CRATE",this.sprite=new H({texture:t.texture,sheetOffsetX:t.sheetOffsetX??0,sheetOffsetY:t.sheetOffsetY??0,frameWidth:t.frameWidth??8,frameHeight:t.frameHeight??8,isAnimated:t.isAnimated??!1,maxFrames:t.maxFrames??1,animDelay:t.animDelay??100,x:t.x,y:t.y}),this.velX=t.velX??0,this.velY=t.velY??0,this.hitboxOffsetX=2,this.hitboxOffsetY=2,this.hitbox.w=this.sprite.frameWidth-4,this.hitbox.h=4,this.entityInFront=null,this.cratePosition=1,this.canHighlight=!0,this.highlightRect=new M(0,0,this.sprite.frameWidth,this.sprite.frameHeight),this.highlightState="growing"}update(){this.baseUpdate(),this.sprite.x=this.x,this.sprite.y=this.y,this.sprite.update(),this.highlightRect.x=this.x-.5*(this.highlightRect.w-this.sprite.frameWidth),this.highlightRect.y=this.y-.5*(this.highlightRect.h-this.sprite.frameHeight),this.canHighlight&&("i"===this.highlightState?this.highlightRect.w<this.sprite.frameWidth+6?(this.highlightRect.w+=.1,this.highlightRect.h+=.1):this.highlightState="d":this.highlightRect.w>this.sprite.frameWidth?(this.highlightRect.w-=.1,this.highlightRect.h-=.1):this.highlightState="i")}render(t){this.canHighlight&&this.highlightRect.x>0&&this.highlightRect.y>0&&(t.fillStyle="#a0cf0a",t.fillRect(Math.round(this.highlightRect.x),Math.round(this.highlightRect.y),Math.round(this.highlightRect.w),Math.round(this.highlightRect.h))),this.sprite.render(t)}}class j extends W{constructor(t={}){super(t.x,t.y),this.sprite=new H({texture:t.texture,sheetOffsetX:t.sheetOffsetX??0,sheetOffsetY:t.sheetOffsetY??0,frameWidth:t.frameWidth??8,frameHeight:t.frameHeight??8,isAnimated:t.isAnimated??!1,maxFrames:t.maxFrames??1,animDelay:t.animDelay??100,x:t.x,y:t.y}),this.velX=t.velX??0,this.velY=t.velY??0,this.hitbox.w=this.sprite.frameWidth,this.hitbox.h=this.sprite.frameHeight}update(){this.baseUpdate(),this.sprite.x=this.x,this.sprite.y=this.y,this.sprite.update()}render(t){this.sprite.render(t)}}!function(){function e(){switch(n){case 0:case 1:{a=0,f.length=0,c.length=0,d.length=0,g.length=0;for(let e=0;e<i/8+1;e++)for(let i=0;i<h/8;i++){let h=new S({texture:l.tiles,x:8*e,y:8*i,frame:t(0,3),maxFrames:4,animDelay:t(15,30),isAnimated:!0,loop:!0});f.push(h)}let e=new G(i/2,h/2);d.push(e);let s=new N(i/2-16,h/2);d.push(s);break}case 2:f.length=0,c.length=0,d.length=0,g.length=0;for(let e=0;e<i/8+1;e++)for(let i=0;i<h/8;i++){let h=new S({texture:l.tiles,x:8*e,y:8*i,frame:t(0,3),maxFrames:4,animDelay:t(15,30),isAnimated:!0,loop:!0});f.push(h)}}}function y(){switch(n){case 0:case 1:{let y=m(),x=u();D>0?D--:0==D&&(!function(){switch(n){case 0:case 1:1==n&&(n=2),e()}}(),D=-1);for(let p=0;p<f.length;p++){let E=f[p];E.x-=.5,E.update&&E.update(),E.x<-16&&(f.splice(p,1),p--)}for(let Y=0;Y<c.length;Y++){let H=c[Y];H.x-=.5,H.update&&H.update(),y&&(Object.is(y,H)||F(y.hitbox,H.hitbox)&&y.hit()),x&&(Object.is(x,H)||F(x.hitbox,H.hitbox)&&x.hit());for(let M=0;M<d.length;M++){let W=d[M];["CRATE","CRATE_TRAILING"].includes(W.key)&&F(W.hitbox,H.hitbox)&&(W.canDestroy=!0)}H.x<-16&&(c.splice(Y,1),Y--)}for(let L=0;L<d.length;L++){let G=d[L];if("CRATE_TRAILING"===G.key&&x){let N=G.entityInFront;if(null==N){let U=null,B=[];for(let q=0;q<d.length;q++){let z=d[q];"CRATE_TRAILING"==z.key&&(B.push(z),U?z.cratePosition>U.cratePosition&&!z.canDestroy&&(U=z):U=z)}G.cratePosition=B.length,G.entityInFront=U??x??null}G.x=N.x-12,G.y<N.y-2?G.y+=.1:G.y<N.y&&(G.velY=.25),G.y>N.y+2?G.y-=.1:G.y>N.y&&(G.velY=-.25)}if(G.update&&G.update(),["CRATE","CRATE_TRAILING"].includes(G.key)){function s(){let t=null,e=[];for(let i=0;i<d.length;i++){let h=d[i];"CRATE_TRAILING"==h.key&&(e.push(h),t?h.cratePosition>t.cratePosition&&!h.canDestroy&&(t=h):t=h)}G.cratePosition=e.length,G.entityInFront=t??x??null,G.entityInFront&&"CRATE"==G.key&&(G.key="CRATE_TRAILING",G.canHighlight=!1,G.velX=0,G.x=G.entityInFront.x-12,G.y=G.entityInFront.y,X=G)}y&&(Object.is(y,G)||F(y.hitbox,G.hitbox)&&"CRATE"==G.key&&s()),x&&(Object.is(x,G)||F(x.hitbox,G.hitbox)&&"CRATE"==G.key&&s())}else y&&(Object.is(y,G)||F(y.hitbox,G.hitbox)&&y.hit()),x&&(Object.is(x,G)||F(x.hitbox,G.hitbox)&&x.hit());for(let J=0;J<d.length;J++){let K=d[J];["CRATE","CRATE_TRAILING"].includes(K.key)&&(Object.is(K,G)||Object.is(G,y)||Object.is(G,x)||F(K.hitbox,G.hitbox)&&(K.canDestroy=!0))}void 0!==G.destroyOnComplete&&G.hasAnimationCompleted&&(G.canDestroy=!0),G.canDestroy&&(d.splice(L,1),L--)}for(let Q=0;Q<g.length;Q++){let V=g[Q];V.update(),V.canDestroy&&g.splice(Q,1)}if(y&&(C("w")?y.velY=-.5:C("s")?y.velY=.5:y.velY=0,C("a")?y.velX=-1:C("d")?y.velX=1:y.velX=0),y&&x&&(x.x<y.x-22?(x.velX=.75,y.velX/=3):x.x<y.x-22&&(x.velX=.1),x.x>y.x+22?(x.velX=-1,y.velX/=3):x.x>y.x-22&&(x.velX=-.75),y.velX-=.25,x.y<y.y-16?(x.y+=.75,y.velY/=3):x.y<y.y&&(x.velY=.25),x.y>y.y+16?(x.y-=.75,y.velY/=3):x.y>y.y&&(x.velY=-.25),x.velX-=.25),v<A?v++:(R>3&&(R-=t(0,1)),b+=t(-1,1),b<0?b=0:b>h/8-R&&(O=h/8-R),O=b+R,v=0,A=t(80,120)),w<15)w++;else{for(let Z=0;Z<k.length;Z++)k[Z]<1e3&&k[Z]++;for(let $=0;$<h/8;$++){let tt=!1,et=P(r,$),it=P(r,$-1),ht=P(r+1,$),st=P(r,$+1),rt=P(r-1,$);if(et.canPlace){let at=8,nt=48,lt=8,ot=8,ft=!1,ct=!1,yt=!1,dt=!1,gt=!1,xt=!1;it.canPlace||(nt-=8,yt=!0),st.canPlace||(nt+=8,gt=!0),rt.canPlace||(at-=8,xt=!0),ht.canPlace||(at+=8,dt=!0),et.perlin>=.2&&et.perlin<.5&&(at=32,it.canPlace&&it.perlin<.2&&(nt-=8),st.canPlace&&st.perlin<.2&&(nt+=8),rt.canPlace&&rt.perlin<.2&&(at-=8),ht.canPlace&&ht.perlin<.2&&(at+=8)),et.perlin>=.5&&(at=64,it.canPlace&&it.perlin<.2&&(nt-=8),st.canPlace&&st.perlin<.2&&(nt+=8),rt.canPlace&&rt.perlin<.2&&(at-=8),ht.canPlace&&ht.perlin<.2&&(at+=8)),t(0,100)>90&&(t(0,100)>50?gt&&8*$<h/2&&(at=16*t(0,2),nt=16,lt=16,ot=16,ft=!0,I||(ct=!0,I=!0),$+1<20&&(k[$+1]=0)):yt&&8*$>h/2&&(at=16*t(0,2),nt=16,lt=16,ot=16,ft=!0,I||(ct=!0,I=!0),$+1<20&&(k[$+1]=0)));let mt=new S({texture:l.tiles,sheetOffsetX:at,sheetOffsetY:nt,frameWidth:lt,frameHeight:ot,shouldRenderLast:ft,canHighlight:ct,x:i,y:8*$});c.push(mt),k[$]=0,tt=!0}if(!tt){let ut=new S({texture:l.tiles,x:i,y:8*$,frame:t(0,3),maxFrames:4,animDelay:t(15,30),isAnimated:!0,loop:!0});f.push(ut)}}if(T<10)T++;else{let pt=[];k.forEach((t=>{t>22&&pt.push(t)}));let wt=8*k.indexOf(pt[t(0,pt.length-1)]);if(t(0,100)>50){let Rt=8*t(0,2),bt=8,Ot=8,vt="SAILBOAT";t(0,100)>50&&(Rt=0,bt=8*t(2,4),16==bt?(Ot=32,vt="FREIGHT_S"):24==bt?(Ot=40,vt="FREIGHT_M"):32==bt&&(Ot=48,vt="FREIGHT_L"));let At=new j({texture:l.entities,sheetOffsetX:Rt,sheetOffsetY:bt,frameWidth:Ot,x:i,y:wt,velX:(a=.8,o=1.2,-(Math.random()*(o-a)+a))});At.key=vt,d.push(At),T=0}else{let kt=24+8*t(0,3),Tt=0,It=8,Xt=new _({texture:l.entities,sheetOffsetX:kt,sheetOffsetY:Tt,frameWidth:It,x:i,y:wt,velX:-.5});d.push(Xt)}}r++,w=0}break}case 2:for(let Dt=0;Dt<f.length;Dt++){f[Dt].update()}}var a,o}function x(){s.clearRect(0,0,i,h),s.setTransform(1,0,0,1,0,0);let t=m(),e=u();switch(n){case 0:case 1:f.forEach((t=>{t.render(s)})),t&&e&&(s.fillStyle="#2e7320",E(s,[t.x,t.y+4],[e.x+16,e.y+4],1));for(let t=0;t<d.length;t++){let e=d[t];"CRATE_TRAILING"==e.key&&(null===e.entityInFront||e.entityInFront.canDestroy||(s.fillStyle="#2e7320",E(s,[e.x+8,e.y+4],[e.entityInFront.x,e.entityInFront.y+4],1))),e.render&&(e.render(s),s.fillRect(e.hitbox.x,e.hitbox.y,e.hitbox.w,e.hitbox.height))}for(let t=0;t<g.length;t++){let e=g[t];e.render&&e.render(s)}c.forEach((t=>{t.shouldRenderLast||t.render(s)})),c.forEach((e=>{e.shouldRenderLast&&(e.render(s),t&&p(t.x,t.y,e.x,e.y)<24&&(s.fillStyle="#a0cf0a",s.fillText("SPACE TO UNLOAD",t.x-34,t.y-16)))}));break;case 2:f.forEach((t=>{t.shouldRenderLast||t.render(s)}))}0==n?(s.drawImage(l.title,i/2-66,8,3*l.title.width,3*l.title.height),s.drawImage(l.copyright,i/2-66,68),s.drawImage(l.btnplay,i/2-30,112,60,15),s.fillStyle="#a0cf0a",s.fillText("MADE FOR JS13K22",4,h-6)):1==n?(s.fillStyle="#a0cf0a",s.fillText("SCORE: "+a,4,8)):2==n&&(s.drawImage(l.gameover,i/2-105,16,3*l.gameover.width,3*l.gameover.height),s.drawImage(l.yousunk,i/2-65,48,2*l.yousunk.width,2*l.yousunk.height),s.drawImage(l.btnplay,i/2-30,112,60,15),s.fillStyle="#a0cf0a",s.fillText("FINAL SCORE: "+a,i/2-38,90))}function Y(){y(),x(),requestAnimationFrame(Y)}window.addEventListener("keydown",(function(t){const e=t.key;o[e]=!0})),window.addEventListener("keyup",(function(t){const i=t.key;if(o[i]=!1,"Enter"==i&&(0!=n&&2!=n||(n=1,e())),1==n&&" "==i){let t=m();u();for(let e=0;e<c.length;e++){let i=c[e];if(i.shouldRenderLast&&t&&p(t.x,t.y,i.x,i.y)<24)for(let t=0;t<d.length;t++){let e=d[t];"CRATE_TRAILING"==e.key&&(a+=100,e.canDestroy=!0)}}}})),async function(){await async function(){await(async()=>{l.title="title",l.copyright="copyright",l.entities="entities",l.tiles="tiles",l.smoke="smoke",l.btnplay="btnplay",l.gameover="gameover",l.yousunk="yousunk";for(const[t,e]of Object.entries(l)){let i=[];i.push(new Promise(((i,h)=>{l[t]=new Image,l[t].src="./images/"+e+".webp",l[t].addEventListener("load",(()=>{i()}))}))),await Promise.all(i)}})()}(),e(),Y()}()}();