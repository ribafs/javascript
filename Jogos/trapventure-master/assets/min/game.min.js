function SfxrParams(){this.setSettings=function(a){for(var b=0;24>b;b++)this[String.fromCharCode(97+b)]=a[b]||0;this.c<.01&&(this.c=.01);var c=this.b+this.c+this.e;if(.18>c){var d=.18/c;this.b*=d,this.c*=d,this.e*=d}}}function SfxrSynth(){this._params=new SfxrParams;var a,b,c,d,e,f,g,h,i,j,k,l;this.reset=function(){var a=this._params;d=100/(a.f*a.f+.001),e=100/(a.g*a.g+.001),f=1-.01*a.h*a.h*a.h,g=1e-6*-a.i*a.i*a.i,a.a||(k=.5-a.n/2,l=5e-5*-a.o),h=1+a.l*a.l*(a.l>0?-.9:10),i=0,j=1==a.m?0:2e4*(1-a.m)*(1-a.m)+32},this.totalReset=function(){this.reset();var d=this._params;return a=1e5*d.b*d.b,b=1e5*d.c*d.c,c=1e5*d.e*d.e+12,3*(0|(a+b+c)/3)},this.synthWave=function(m,n){var o=this._params,p=1!=o.s||o.v,q=.1*o.v*o.v,r=1+3e-4*o.w,s=.1*o.s*o.s*o.s,t=1+1e-4*o.t,u=1!=o.s,v=o.x*o.x,w=o.g,x=o.q||o.r,y=.2*o.r*o.r*o.r,z=o.q*o.q*(o.q<0?-1020:1020),A=o.p?(0|2e4*(1-o.p)*(1-o.p))+32:0,B=o.d,C=o.j/2,D=.01*o.k*o.k,E=o.a,F=a,G=1/a,H=1/b,I=1/c,J=5/(1+20*o.u*o.u)*(.01+s);J>.8&&(J=.8),J=1-J;for(var K,L,M,N,O,P,Q=!1,R=0,S=0,T=0,U=0,V=0,W=0,X=0,Y=0,Z=0,$=0,_=new Array(1024),ab=new Array(32),bb=_.length;bb--;)_[bb]=0;for(var bb=ab.length;bb--;)ab[bb]=2*Math.random()-1;for(var bb=0;n>bb;bb++){if(Q)return bb;if(A&&++Z>=A&&(Z=0,this.reset()),j&&++i>=j&&(j=0,d*=h),f+=g,d*=f,d>e&&(d=e,w>0&&(Q=!0)),L=d,C>0&&($+=D,L*=1+Math.sin($)*C),L|=0,8>L&&(L=8),E||(k+=l,0>k?k=0:k>.5&&(k=.5)),++S>F)switch(S=0,++R){case 1:F=b;break;case 2:F=c}switch(R){case 0:T=S*G;break;case 1:T=1+2*(1-S*H)*B;break;case 2:T=1-S*I;break;case 3:T=0,Q=!0}x&&(z+=y,M=0|z,0>M?M=-M:M>1023&&(M=1023)),p&&r&&(q*=r,1e-5>q?q=1e-5:q>.1&&(q=.1)),P=0;for(var cb=8;cb--;){if(X++,X>=L&&(X%=L,3==E))for(var db=ab.length;db--;)ab[db]=2*Math.random()-1;switch(E){case 0:O=k>X/L?.5:-.5;break;case 1:O=1-2*(X/L);break;case 2:N=X/L,N=6.28318531*(N>.5?N-1:N),O=1.27323954*N+.405284735*N*N*(0>N?1:-1),O=.225*((0>O?-1:1)*O*O-O)+O;break;case 3:O=ab[Math.abs(0|32*X/L)]}p&&(K=W,s*=t,0>s?s=0:s>.1&&(s=.1),u?(V+=(O-W)*s,V*=J):(W=O,V=0),W+=V,U+=W-K,U*=1-q,O=U),x&&(_[Y%1024]=O,O+=_[(Y-M+1024)%1024],Y++),P+=O}P*=.125*T*v,m[bb]=P>=1?32767:-1>=P?-32768:0|32767*P}return n}}function ArcadeAudio(){this.sounds={}}function Enemy(a,b){this.x=a,this.y=b,this.vx=0,this.vy=0,this.width=12,this.height=30,this.isDead=!1,this.rotation=0,this.rotationDelta=0,this.path=[],this.lastUpdate=0,this.state=0,this.frame=0,this.img=new Image,this.img.src="assets/images/sprite.png"}function musicLoop(){music=setInterval(function(){aa.play("music")},3e3)}function loadMap(){map=maps[0],enemies=[],tiles=[],world=[],$("#name").innerHTML="["+names[0]+"]",$("#instructions").innerHTML=instructions[0]||"";for(var a=0;a<map.length;a++){tiles[a]=[];for(var b=0;b<map[0].length;b++)if(4===map[a][b])player=new Player(b*tilesize,a*tilesize),tiles[a][b]=new Tile(b*tilesize,a*tilesize,1),world.push(tiles[a][b]);else if(6===map[a][b]){var c=new Enemy(b*tilesize,a*tilesize);enemies.push(c),tiles[a][b]=new Tile(b*tilesize,a*tilesize,1),world.push(tiles[a][b])}else tiles[a][b]=new Tile(b*tilesize,a*tilesize,map[a][b]),world.push(tiles[a][b]),5===map[a][b]&&(exit=tiles[a][b])}for(var d=0;d<enemies.length;d+=1)world.push(enemies[d]);world.push(player),animFrame||(animFrame=requestAnimationFrame(loop)),initPaths()}function nextMap(){endReached=!0,aa.play("exit"),$("#black").classList.remove("hidden"),$("#name").classList.remove("hidden"),$("#title").classList.add("hidden"),setTimeout(function(){maps.shift(),names.shift(),instructions.shift(),loadMap(),endReached=!1,$("#black").classList.add("hidden")},600)}function initPaths(){clearInterval(pathInterval),pathInterval=setInterval(function(){for(var a=0;a<enemies.length;a+=1)enemies[a].checkPath()},1e3)}function toggleTraps(){var a=new Date,b=a-lastToggle;if(!(300>b)){lastToggle=a;for(var c=0;c<world.length;c+=1)world[c]instanceof Tile&&world[c].toggle(),world[c]instanceof Enemy&&world[c].checkTraps();for(var c=0;c<enemies.length;c+=1)enemies[c].checkPath();aa.play("traps"),player.checkTraps()}}function getTileAt(a,b){var a=Math.floor(a/tilesize),b=Math.floor(b/tilesize);return tiles[b]&&tiles[b][a]?tiles[b][a]:{type:0,isWalkable:!1}}function loop(){if(!endReached){var a=new Date,b=(a-lastUpdate)/1e3,c=world.length;ctx.clearRect(0,0,canvas.width,canvas.height);var d=map[0].length*tilesize/2,e=map.length*tilesize/2;ctx.save(),ctx.translate(320-d,240-e);for(var f=0;c>f;f+=1)world[f].update(b),world[f].draw(ctx);for(var f=0;c>f;f+=1)world[f]instanceof Tile&&2===world[f].type&&world[f].draw(ctx);ctx.restore(),lastUpdate=a}animFrame=requestAnimationFrame(loop)}function $(a){return document.querySelector(a)}function Player(a,b){this.x=a+tilesize/2,this.y=b+tilesize/2,this.vx=0,this.vy=0,this.width=12,this.height=30,this.isDead=!1,this.rotation=0,this.rotationDelta=0,this.lastUpdate=0,this.state=0,this.frame=0,this.img=new Image,this.img.src="assets/images/sprite.png"}var synth=new SfxrSynth;window.jsfxr=function(a){synth._params.setSettings(a);var b=synth.totalReset(),c=new Uint8Array(4*(0|(b+1)/2)+44),d=2*synth.synthWave(new Uint16Array(c.buffer,44),b),e=new Uint32Array(c.buffer,0,44);e[0]=1179011410,e[1]=d+36,e[2]=1163280727,e[3]=544501094,e[4]=16,e[5]=65537,e[6]=44100,e[7]=88200,e[8]=1048578,e[9]=1635017060,e[10]=d,d+=44;for(var f=0,g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",h="data:audio/wav;base64,";d>f;f+=3){var i=c[f]<<16|c[f+1]<<8|c[f+2];h+=g[i>>18]+g[63&i>>12]+g[63&i>>6]+g[63&i]}return h},ArcadeAudio.prototype.add=function(a,b,c){this.sounds[a]=[],c.forEach(function(c,d){this.sounds[a].push({tick:0,count:b,pool:[]});for(var e=0;b>e;e++){var f=new Audio;f.src=jsfxr(c),this.sounds[a][d].pool.push(f)}},this)},ArcadeAudio.prototype.play=function(a){var b=this.sounds[a],c=b.length>1?b[Math.floor(Math.random()*b.length)]:b[0];c.pool[c.tick].play(),c.tick<c.count-1?c.tick++:c.tick=0},Astar=function(a,b){this.startNode=a,this.endNode=b,this.openNodes=[],this.closedNodes=[],this.openNodes.push(a)},Astar.prototype={getPath:function(){if(this.startNode===this.endNode)return[];do{var a=this.getLowestFfromOpenNodes();if(a===this.endNode)return this.calcPathList();this.closedNodes.push(a),this.expandNode(a)}while(this.openNodes.length);return[]},calcPathList:function(){var a=this.endNode,b=[];do a.isPath=!0,b.push(a),a.astar.parent&&(a=a.astar.parent);while(a!==this.startNode);return b.reverse(),b},getLowestFfromOpenNodes:function(){return this.openNodes.sort(function(a,b){return a.astar.f-b.astar.f}),this.openNodes.shift()},expandNode:function(a){for(var b=a.getNeighbours(),c=0,d=b.length;d>c;c++){var e=b[c];if(!(this.closedNodes.indexOf(e)>-1)){var f=a.astar.g+10;if(!(this.openNodes.indexOf(e)>-1&&f>e.astar.g)){e.astar.parent=a,e.astar.g=f;var g=Math.abs(this.endNode.x-e.x)+Math.abs(this.endNode.y-e.y);e.astar.f=f+g,-1===this.openNodes.indexOf(e)&&this.openNodes.push(e)}}}}},Enemy.prototype={update:function(){if(this.isDead)this.vy*=.99,this.vy+=.5,this.rotation+=this.rotationDelta;else if(this.path.length){var a=this.path[0].x-this.x,b=this.path[0].y-this.y;4>a&&a>-4&&(a=0),4>b&&b>-4&&(b=0),2>a&&a>-2&&2>b&&b>-2&&(this.vx=0,this.vy=0,this.path.shift()),this.path[0]&&!this.path[0].isWalkable&&(this.path=[getTileAt(this.x+tilesize/2,this.y+tilesize/2)]),0>a&&(this.vx=-1),a>0&&(this.vx=1),0>b&&(this.vy=-1),b>0&&(this.vy=1)}else this.vx=0,this.vy=0;this.x+=this.vx,this.y+=this.vy,this.checkStates()},draw:function(a){var b=this.width,c=this.height,d=this.x,e=this.y;new Date-this.lastUpdate>(this.state?200:750)&&(this.lastUpdate=new Date,this.frame=1-this.frame);var f=this.frame+2*this.state;this.isDead?(a.save(),a.translate(d+tilesize/2,e+tilesize/2),a.rotate((90+this.rotation)*Math.PI/180),a.drawImage(this.img,12,30,12,29,-b/2,-c/2,b,c),a.restore()):(a.save(),a.translate(d+tilesize/2,e+tilesize/2),a.drawImage(this.img,12*f,30,12,29,-b/2,-c/2,b,c),a.restore())},checkStates:function(){this.vx>0&&(this.state=1),this.vx<0&&(this.state=3),0!==this.vy&&(this.state=2),this.path.length||(this.state=0)},checkPath:function(){if(!this.isDead){for(var a=0;a<this.path.length;a++)if(!this.path[a].isWalkable)return;var b=getTileAt(this.x+tilesize/2,this.y+tilesize/2),c=getTileAt(player.x,player.y),d=new Astar(b,c);this.path=d.getPath()}},checkTraps:function(){if(!this.isDead){var a=this.x+tilesize/2,b=this.y+tilesize/2,c=this.width/2,d=this.height/2;if(!getTileAt(a-c,b-d).isWalkable||!getTileAt(a+c,b+d).isWalkable){this.isDead=!0,this.path=[],this.vy=-12,this.rotationDelta=4*(-1+2*Math.random()),aa.play("kill");for(var e=0;e<enemies.length;e++)if(!enemies[e].isDead)return;exit&&(exit.type=7),aa.play("unlock")}}}};var game=game||{},canvas=$("#game"),ctx=canvas.getContext("2d"),lastUpdate=new Date,aa=new ArcadeAudio,player,tilesize=40,instructions=["Find the treasure inside the dungeon.","Press <em>space</em> to reverse traps."],names=["trapventure","dusty stairways","the trap","the fork way","the large hall","no snakes here","the prison","the persian room","the only way","shattered pillars","test of will","the last chamber"],maps=[[[4,1,1,1,7]],[[4,1,1,2,1,1,3,1,1,7]],[[4,1,1,1,2,2,1,6,1,5]],[[6,1,1,1,1,1,1,6,5],[0,0,0,0,1,0,0,0,0],[0,0,0,0,2,0,0,0,0],[4,1,1,1,1,0,0,0,0]],[[0,0,1,1,1,1,6,0,0],[0,0,1,1,1,1,1,0,0],[4,1,1,1,3,1,1,1,5],[0,0,1,1,1,1,6,0,0],[0,0,1,1,1,1,1,0,0]],[[6,0,1,6,1,0,1,6,1,0],[1,0,1,0,1,0,1,0,1,0],[1,0,2,0,2,0,3,0,1,5],[1,0,1,0,1,0,1,0,0,0],[1,4,1,0,1,6,1,0,0,0]],[[0,0,0,6,0,0,0,0,0,0,0,0,0],[0,0,0,2,1,1,1,3,1,6,0,0,0],[0,0,0,1,0,0,0,2,2,1,0,0,0],[0,0,0,1,0,3,6,2,6,0,0,0,0],[0,0,0,3,0,6,0,1,1,1,2,6,5],[0,0,0,3,0,1,0,0,0,0,0,0,0],[6,1,4,1,2,2,2,6,6,6,0,0,0]],[[0,1,3,1,2,6,2,1,3,6,0],[1,3,1,2,1,3,1,2,1,3,1],[4,2,3,1,2,6,2,1,3,2,5],[1,3,1,2,1,3,1,2,1,3,1],[0,1,3,1,2,6,2,1,3,6,0]],[[4,1,1,1,1,6],[0,0,3,0,0,0],[0,0,1,0,0,0],[0,0,1,0,0,0],[0,0,1,0,0,0],[0,0,6,0,0,0],[0,0,2,0,0,0],[0,0,1,1,1,5]],[[0,0,0,0,4,0,0,0,0],[0,0,1,2,1,3,1,0,0],[0,0,6,0,1,0,1,0,0],[6,0,1,0,1,0,6,0,1],[1,1,1,1,5,1,1,1,1],[1,0,6,0,1,0,1,0,6],[0,0,1,3,1,2,6,0,0]],[[0,6,1,0,6,0,1,6,0],[0,0,1,1,1,1,1,0,0],[0,0,1,1,1,1,1,0,0],[4,1,1,1,3,1,1,1,6],[0,0,1,1,1,1,6,0,0],[0,0,1,1,6,1,1,0,0],[0,0,0,0,5,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,6,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,0,0,1,1,1],[4,1,1,1,1,1,1,1,1,2,1,1,8,1],[0,0,0,0,0,0,0,0,1,0,0,1,1,1],[0,0,0,6,1,1,1,1,1,0,0,0,0,0]]],map,enemies=[],tiles=[],world=[],exit,animFrame,music,isMusic=!0,pathInterval,lastToggle=new Date,endReached=!1;game.init=function(){aa.add("music",2,[[1,,.7701,.0022,.9,.47,,-.5,.02,.0573,,.2199,.16,,.2284,.9413,-.8104,.5374,.0495,.1138,-.5678,.3631,.9268,.2],[1,,.7701,.0022,.9,.47,,0,.02,.0573,,.2199,.16,,.2284,.9413,-.8104,.5374,.0495,.1138,-.5678,.3631,.9268,.2],[1,,.7701,.0022,.9,.47,,.5,.02,.0573,,.2199,.16,,.2284,.9413,-.8104,.5374,.0495,.1138,-.5678,.3631,.9268,.2],[1,,.7701,.0022,.9,.47,,1,.02,.0573,,.2199,.16,,.2284,.9413,-.8104,.5374,.0495,.1138,-.5678,.3631,.9268,.2]]),aa.add("win",2,[[2,.2401,.5158,.5032,.91,.38,,-.02,,.0092,.1956,-.125,-.2412,,-.0988,,.0758,.3728,.5567,.3993,.3231,.0068,-.2971,.5]]),aa.add("traps",10,[[1,.0592,.0217,.0742,.39,.8641,,-.56,.0873,.0726,.5921,-.1226,.4539,.0532,.6772,.3002,.6834,-.7991,.836,-.0011,.9134,.1809,.3207,.56]]),aa.add("die",2,[[0,,.3644,.2851,.4672,.5159,,,-.0944,.4041,.6285,-.8575,.8297,,.3028,-.0975,-.0359,-.012,.93,.1857,,.1225,,.56]]),aa.add("respawn",2,[[0,.3391,.01,.5415,.5428,.2102,,,-.095,,.3503,.5185,,-.1944,-.8553,.5259,.2493,.2691,.8178,.0824,.7013,.1288,-6e-4,.5]]),aa.add("kill",10,[[2,.0708,.1102,.4156,.8265,.5,,-.2134,-.3753,-.0018,,-.2358,-.6747,.662,-.2579,,,.1023,.9993,.0498,.329,.2427,.0014,.56]]),aa.add("exit",2,[[2,.134,.8654,.4633,.3,.1216,,.3067,-.5325,,-.8813,.8807,,.9535,.3137,.24,.2148,.0101,.8141,.0372,.7263,,-.2908,.56]]),aa.add("unlock",2,[[0,,.0891,.5663,.3068,.8345,,,,,,.5995,.5384,,,,,,1,,,,,.56]]),document.addEventListener("keydown",function(a){var b=player.vx,c=player.vy,d=a.which;(65===d||37===d)&&(b=-1),(68===d||39===d)&&(b=1),(87===d||38===d)&&(c=-1),(83===d||40===d)&&(c=1),32===d&&toggleTraps(),player.move(b,c)}),document.addEventListener("keyup",function(a){var b=y=!1,c=a.which;(65===a.which||68===a.which||37===c||39===c)&&(b=!0),(87===a.which||83===a.which||38===c||40===c)&&(y=!0),player.stop(b,y)}),$("#music").addEventListener("click",function(){isMusic=!isMusic,isMusic?(musicLoop(),this.classList.remove("off")):(clearInterval(music),this.classList.add("off"))}),setTimeout(function(){$("#black").classList.add("hidden")},1e3),aa.play("music"),musicLoop(),loadMap()},Player.prototype={move:function(a,b){this.isDead||(this.vx=a,this.vy=b,this.checkStates())},stop:function(a,b){this.isDead||(a&&(this.vx=0),b&&(this.vy=0),this.checkStates())},checkStates:function(){this.vx>0&&(this.state=1),this.vx<0&&(this.state=3),0!==this.vy&&(this.state=2),0===this.vx&&0===this.vy&&(this.state=0)},update:function(){if(this.isDead)return this.vy*=.99,this.vy+=.5,this.rotation+=this.rotationDelta,this.x+=this.vx,this.y+=this.vy,void 0;var a=this.x,b=this.y,c=this.width/2,d=this.height/2,e=a+1.5*this.vx,f=b+1.5*this.vy;(this.vx<0&&getTileAt(e-c,f).isWalkable||this.vx>0&&getTileAt(e+c,f).isWalkable)&&(this.x=e),(this.vy<0&&getTileAt(e,f-d).isWalkable||this.vy>0&&getTileAt(e,f+d).isWalkable)&&(this.y=f);for(var g=0;g<enemies.length;g+=1){var h=enemies[g],i=h.x+tilesize/2,j=h.y+tilesize/2,k=i-a,l=j-b;h.isDead||Math.abs(k)<h.width/2+(c-4)&&Math.abs(l)<h.height/2+(d-4)&&this.die()}7===getTileAt(a,b).type&&nextMap(),8===getTileAt(a,b).type&&(endReached=!0,$("#instructions").innerHTML="You survived and found the treasure.<br />Thanks for playing.",aa.play("win"))},draw:function(a){var b=this.width,c=this.height,d=this.x,e=this.y;new Date-this.lastUpdate>(this.state?200:500)&&(this.lastUpdate=new Date,this.frame=1-this.frame);var f=this.frame+2*this.state;a.save(),a.translate(d,e),a.rotate(this.rotation*Math.PI/180),a.drawImage(this.img,12*f,0,12,29,-b/2,-c/2,b,c),a.restore()},checkTraps:function(){var a=this.x,b=this.y,c=this.width/2,d=this.height/2;(2===getTileAt(a-c,b-d).type||2===getTileAt(a+c,b+d).type)&&this.die()},die:function(){this.isDead=!0,this.state=0,this.vy=-12,this.rotation=90,this.rotationDelta=4*(-1+2*Math.random()),aa.play("die"),setTimeout(function(){aa.play("respawn"),loadMap()},1500)}},Tile=function(a,b,c){this.x=a,this.y=b,this.color="rgba(255,255,255,0.25)",this.hasChanged=!1,this.isTarget=!1,this.isWalkable=!1,this.animStep=.2,this.img=new Image,this.img.src="assets/images/sprite.png",this.type=c||0,"13578".indexOf(c)>-1&&(this.isWalkable=!0),this.astar={g:0,h:0,f:0,parent:null}},Tile.prototype={toggle:function(){this.type<2||this.type>3||(this.type=2===this.type?3:2,this.isWalkable=!this.isWalkable,this.animStep=0)},getNeighbours:function(){var a=[],b=this.x/tilesize,c=this.y/tilesize;return a=this.safeAddNeighbour(b+1,c,a),a=this.safeAddNeighbour(b,c-1,a),a=this.safeAddNeighbour(b,c+1,a),a=this.safeAddNeighbour(b-1,c,a)},safeAddNeighbour:function(a,b,c){return tiles[b]&&tiles[b][a]&&tiles[b][a].isWalkable&&c.push(tiles[b][a]),c},update:function(a){-1!=="23".indexOf(this.type)&&(this.animStep+=a,this.animStep>.2&&(this.animStep=.2))},draw:function(a){var b=this.x/tilesize,c=this.y/tilesize,d=20*(this.animStep/.2);-1!=="123578".indexOf(this.type)&&(a.fillStyle="rgba(0,0,0,1)",a.fillRect(this.x,this.y,tilesize,tilesize),tiles[c-1]&&tiles[c-1][b]&&0!==tiles[c-1][b].type||(a.fillStyle="#276059")),2===this.type?(a.fillStyle="#89ccca",a.fillRect(this.x,this.y-d,tilesize,tilesize),a.fillStyle="#679997",a.fillRect(this.x,this.y+40-d,tilesize,d)):3===this.type?(a.fillStyle="#333",a.fillRect(this.x,this.y-(20-d),tilesize,tilesize),a.fillStyle="#222",a.fillRect(this.x,this.y+40-(20-d),tilesize,20-d)):5===this.type?(a.drawImage(this.img,30,60,30,30,this.x+5,this.y+5,30,30),a.strokeStyle="#407876",a.strokeRect(this.x+4,this.y+4,tilesize-8,tilesize-8)):7===this.type?(a.drawImage(this.img,0,60,30,30,this.x+5,this.y+5,30,30),a.strokeStyle="#407876",a.strokeRect(this.x+4,this.y+4,tilesize-8,tilesize-8)):8===this.type&&a.drawImage(this.img,60,60,30,30,this.x+5,this.y+5,30,30)}};